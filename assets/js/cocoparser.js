!function(t){var e=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,s=/^([^\/;?#]*)(.*)$/,r=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,a={buildAbsoluteURL:function(t,e,r){if(r=r||{},t=t.trim(),!(e=e.trim())){if(!r.alwaysNormalize)return t;var i=a.parseURL(t);if(!i)throw new Error("Error trying to parse base URL.");return i.path=a.normalizePath(i.path),a.buildURLFromParts(i)}var n=a.parseURL(e);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return r.alwaysNormalize?(n.path=a.normalizePath(n.path),a.buildURLFromParts(n)):e;var o=a.parseURL(t);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=s.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var d={scheme:o.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(d.netLoc=o.netLoc,"/"!==n.path[0]))if(n.path){var c=o.path,u=c.substring(0,c.lastIndexOf("/")+1)+n.path;d.path=a.normalizePath(u)}else d.path=o.path,n.params||(d.params=o.params,n.query||(d.query=o.query));return null===d.path&&(d.path=r.alwaysNormalize?a.normalizePath(n.path):n.path),a.buildURLFromParts(d)},parseURL:function(t){var s=e.exec(t);return s?{scheme:s[1]||"",netLoc:s[2]||"",path:s[3]||"",params:s[4]||"",query:s[5]||"",fragment:s[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(r,"");t.length!==(t=t.replace(i,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}};"object"==typeof exports&&"object"==typeof module?module.exports=a:"function"==typeof define&&define.amd?define([],(function(){return a})):"object"==typeof exports?exports.URLToolkit=a:t.URLToolkit=a}(this),function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;try{e=window}catch(t){e=self}e.SparkMD5=t()}}((function(t){"use strict";var e=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function s(t,e){var s=t[0],r=t[1],i=t[2],a=t[3];r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&i|~r&a)+e[0]-680876936|0)<<7|s>>>25)+r|0)&r|~s&i)+e[1]-389564586|0)<<12|a>>>20)+s|0)&s|~a&r)+e[2]+606105819|0)<<17|i>>>15)+a|0)&a|~i&s)+e[3]-1044525330|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&i|~r&a)+e[4]-176418897|0)<<7|s>>>25)+r|0)&r|~s&i)+e[5]+1200080426|0)<<12|a>>>20)+s|0)&s|~a&r)+e[6]-1473231341|0)<<17|i>>>15)+a|0)&a|~i&s)+e[7]-45705983|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&i|~r&a)+e[8]+1770035416|0)<<7|s>>>25)+r|0)&r|~s&i)+e[9]-1958414417|0)<<12|a>>>20)+s|0)&s|~a&r)+e[10]-42063|0)<<17|i>>>15)+a|0)&a|~i&s)+e[11]-1990404162|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&i|~r&a)+e[12]+1804603682|0)<<7|s>>>25)+r|0)&r|~s&i)+e[13]-40341101|0)<<12|a>>>20)+s|0)&s|~a&r)+e[14]-1502002290|0)<<17|i>>>15)+a|0)&a|~i&s)+e[15]+1236535329|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&a|i&~a)+e[1]-165796510|0)<<5|s>>>27)+r|0)&i|r&~i)+e[6]-1069501632|0)<<9|a>>>23)+s|0)&r|s&~r)+e[11]+643717713|0)<<14|i>>>18)+a|0)&s|a&~s)+e[0]-373897302|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&a|i&~a)+e[5]-701558691|0)<<5|s>>>27)+r|0)&i|r&~i)+e[10]+38016083|0)<<9|a>>>23)+s|0)&r|s&~r)+e[15]-660478335|0)<<14|i>>>18)+a|0)&s|a&~s)+e[4]-405537848|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&a|i&~a)+e[9]+568446438|0)<<5|s>>>27)+r|0)&i|r&~i)+e[14]-1019803690|0)<<9|a>>>23)+s|0)&r|s&~r)+e[3]-187363961|0)<<14|i>>>18)+a|0)&s|a&~s)+e[8]+1163531501|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r&a|i&~a)+e[13]-1444681467|0)<<5|s>>>27)+r|0)&i|r&~i)+e[2]-51403784|0)<<9|a>>>23)+s|0)&r|s&~r)+e[7]+1735328473|0)<<14|i>>>18)+a|0)&s|a&~s)+e[12]-1926607734|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r^i^a)+e[5]-378558|0)<<4|s>>>28)+r|0)^r^i)+e[8]-2022574463|0)<<11|a>>>21)+s|0)^s^r)+e[11]+1839030562|0)<<16|i>>>16)+a|0)^a^s)+e[14]-35309556|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r^i^a)+e[1]-1530992060|0)<<4|s>>>28)+r|0)^r^i)+e[4]+1272893353|0)<<11|a>>>21)+s|0)^s^r)+e[7]-155497632|0)<<16|i>>>16)+a|0)^a^s)+e[10]-1094730640|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r^i^a)+e[13]+681279174|0)<<4|s>>>28)+r|0)^r^i)+e[0]-358537222|0)<<11|a>>>21)+s|0)^s^r)+e[3]-722521979|0)<<16|i>>>16)+a|0)^a^s)+e[6]+76029189|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((a=((a+=((s=((s+=(r^i^a)+e[9]-640364487|0)<<4|s>>>28)+r|0)^r^i)+e[12]-421815835|0)<<11|a>>>21)+s|0)^s^r)+e[15]+530742520|0)<<16|i>>>16)+a|0)^a^s)+e[2]-995338651|0)<<23|r>>>9)+i|0,r=((r+=((a=((a+=(r^((s=((s+=(i^(r|~a))+e[0]-198630844|0)<<6|s>>>26)+r|0)|~i))+e[7]+1126891415|0)<<10|a>>>22)+s|0)^((i=((i+=(s^(a|~r))+e[14]-1416354905|0)<<15|i>>>17)+a|0)|~s))+e[5]-57434055|0)<<21|r>>>11)+i|0,r=((r+=((a=((a+=(r^((s=((s+=(i^(r|~a))+e[12]+1700485571|0)<<6|s>>>26)+r|0)|~i))+e[3]-1894986606|0)<<10|a>>>22)+s|0)^((i=((i+=(s^(a|~r))+e[10]-1051523|0)<<15|i>>>17)+a|0)|~s))+e[1]-2054922799|0)<<21|r>>>11)+i|0,r=((r+=((a=((a+=(r^((s=((s+=(i^(r|~a))+e[8]+1873313359|0)<<6|s>>>26)+r|0)|~i))+e[15]-30611744|0)<<10|a>>>22)+s|0)^((i=((i+=(s^(a|~r))+e[6]-1560198380|0)<<15|i>>>17)+a|0)|~s))+e[13]+1309151649|0)<<21|r>>>11)+i|0,r=((r+=((a=((a+=(r^((s=((s+=(i^(r|~a))+e[4]-145523070|0)<<6|s>>>26)+r|0)|~i))+e[11]-1120210379|0)<<10|a>>>22)+s|0)^((i=((i+=(s^(a|~r))+e[2]+718787259|0)<<15|i>>>17)+a|0)|~s))+e[9]-343485551|0)<<21|r>>>11)+i|0,t[0]=s+t[0]|0,t[1]=r+t[1]|0,t[2]=i+t[2]|0,t[3]=a+t[3]|0}function r(t){var e,s=[];for(e=0;e<64;e+=4)s[e>>2]=t.charCodeAt(e)+(t.charCodeAt(e+1)<<8)+(t.charCodeAt(e+2)<<16)+(t.charCodeAt(e+3)<<24);return s}function i(t){var e,s=[];for(e=0;e<64;e+=4)s[e>>2]=t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24);return s}function a(t){var e,i,a,n,o,l,d=t.length,c=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=d;e+=64)s(c,r(t.substring(e-64,e)));for(i=(t=t.substring(e-64)).length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<i;e+=1)a[e>>2]|=t.charCodeAt(e)<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(s(c,a),e=0;e<16;e+=1)a[e]=0;return n=(n=8*d).toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(n[2],16),l=parseInt(n[1],16)||0,a[14]=o,a[15]=l,s(c,a),c}function n(t){var s,r="";for(s=0;s<4;s+=1)r+=e[t>>8*s+4&15]+e[t>>8*s&15];return r}function o(t){var e;for(e=0;e<t.length;e+=1)t[e]=n(t[e]);return t.join("")}function l(t){return/[\u0080-\uFFFF]/.test(t)&&(t=unescape(encodeURIComponent(t))),t}function d(t){var e,s=[],r=t.length;for(e=0;e<r-1;e+=2)s.push(parseInt(t.substr(e,2),16));return String.fromCharCode.apply(String,s)}function c(){this.reset()}return"5d41402abc4b2a76b9719d911017c592"!==o(a("hello"))&&function(t,e){var s=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(s>>16)<<16|65535&s},"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function e(t,e){return(t=0|t||0)<0?Math.max(t+e,0):Math.min(t,e)}ArrayBuffer.prototype.slice=function(s,r){var i,a,n,o,l=this.byteLength,d=e(s,l),c=l;return r!==t&&(c=e(r,l)),d>c?new ArrayBuffer(0):(i=c-d,a=new ArrayBuffer(i),n=new Uint8Array(a),o=new Uint8Array(this,d,i),n.set(o),a)}}(),c.prototype.append=function(t){return this.appendBinary(l(t)),this},c.prototype.appendBinary=function(t){this._buff+=t,this._length+=t.length;var e,i=this._buff.length;for(e=64;e<=i;e+=64)s(this._hash,r(this._buff.substring(e-64,e)));return this._buff=this._buff.substring(e-64),this},c.prototype.end=function(t){var e,s,r=this._buff,i=r.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<i;e+=1)a[e>>2]|=r.charCodeAt(e)<<(e%4<<3);return this._finish(a,i),s=o(this._hash),t&&(s=d(s)),this.reset(),s},c.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},c.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},c.prototype.setState=function(t){return this._buff=t.buff,this._length=t.length,this._hash=t.hash,this},c.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},c.prototype._finish=function(t,e){var r,i,a,n=e;if(t[n>>2]|=128<<(n%4<<3),n>55)for(s(this._hash,t),n=0;n<16;n+=1)t[n]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(r[2],16),a=parseInt(r[1],16)||0,t[14]=i,t[15]=a,s(this._hash,t)},c.hash=function(t,e){return c.hashBinary(l(t),e)},c.hashBinary=function(t,e){var s=o(a(t));return e?d(s):s},c.ArrayBuffer=function(){this.reset()},c.ArrayBuffer.prototype.append=function(t){var e,r,a,n,o,l=(r=this._buff.buffer,a=t,n=!0,(o=new Uint8Array(r.byteLength+a.byteLength)).set(new Uint8Array(r)),o.set(new Uint8Array(a),r.byteLength),n?o:o.buffer),d=l.length;for(this._length+=t.byteLength,e=64;e<=d;e+=64)s(this._hash,i(l.subarray(e-64,e)));return this._buff=e-64<d?new Uint8Array(l.buffer.slice(e-64)):new Uint8Array(0),this},c.ArrayBuffer.prototype.end=function(t){var e,s,r=this._buff,i=r.length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(e=0;e<i;e+=1)a[e>>2]|=r[e]<<(e%4<<3);return this._finish(a,i),s=o(this._hash),t&&(s=d(s)),this.reset(),s},c.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},c.ArrayBuffer.prototype.getState=function(){var t,e=c.prototype.getState.call(this);return e.buff=(t=e.buff,String.fromCharCode.apply(null,new Uint8Array(t))),e},c.ArrayBuffer.prototype.setState=function(t){return t.buff=function(t,e){var s,r=t.length,i=new ArrayBuffer(r),a=new Uint8Array(i);for(s=0;s<r;s+=1)a[s]=t.charCodeAt(s);return e?a:i}(t.buff,!0),c.prototype.setState.call(this,t)},c.ArrayBuffer.prototype.destroy=c.prototype.destroy,c.ArrayBuffer.prototype._finish=c.prototype._finish,c.ArrayBuffer.hash=function(t,e){var r=o(function(t){var e,r,a,n,o,l,d=t.length,c=[1732584193,-271733879,-1732584194,271733878];for(e=64;e<=d;e+=64)s(c,i(t.subarray(e-64,e)));for(r=(t=e-64<d?t.subarray(e-64):new Uint8Array(0)).length,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e=0;e<r;e+=1)a[e>>2]|=t[e]<<(e%4<<3);if(a[e>>2]|=128<<(e%4<<3),e>55)for(s(c,a),e=0;e<16;e+=1)a[e]=0;return n=(n=8*d).toString(16).match(/(.*?)(.{0,8})$/),o=parseInt(n[2],16),l=parseInt(n[1],16)||0,a[14]=o,a[15]=l,s(c,a),c}(new Uint8Array(t)));return e?d(r):r},c})),(t=>{const e={log:()=>{},error:()=>{},warn:()=>{},debug:()=>{},trace:()=>{}},s={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_RESET:"hlsBufferReset",BUFFER_CODECS:"hlsBufferCodecs",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_EOS:"hlsBufferEos",BUFFER_FLUSHING:"hlsBufferFlushing",BUFFER_FLUSHED:"hlsBufferFlushed",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_SWITCHING:"hlsLevelSwitching",LEVEL_SWITCHED:"hlsLevelSwitched",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVELS_UPDATED:"hlsLevelsUpdated",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",SUBTITLE_TRACKS_UPDATED:"hlsSubtitleTracksUpdated",SUBTITLE_TRACK_SWITCH:"hlsSubtitleTrackSwitch",SUBTITLE_TRACK_LOADING:"hlsSubtitleTrackLoading",SUBTITLE_TRACK_LOADED:"hlsSubtitleTrackLoaded",SUBTITLE_FRAG_PROCESSED:"hlsSubtitleFragProcessed",CUES_PARSED:"hlsCuesParsed",NON_NATIVE_TEXT_TRACKS_FOUND:"hlsNonNativeTextTracksFound",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_LOADING:"hlsKeyLoading",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition",LIVE_BACK_BUFFER_REACHED:"hlsLiveBackBufferReached"};var r,i;!function(t){t.NETWORK_ERROR="networkError",t.MEDIA_ERROR="mediaError",t.KEY_SYSTEM_ERROR="keySystemError",t.MUX_ERROR="muxError",t.OTHER_ERROR="otherError"}(r||(r={})),function(t){t.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",t.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",t.KEY_SYSTEM_NO_SESSION="keySystemNoSession",t.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",t.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",t.MANIFEST_LOAD_ERROR="manifestLoadError",t.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",t.MANIFEST_PARSING_ERROR="manifestParsingError",t.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",t.LEVEL_EMPTY_ERROR="levelEmptyError",t.LEVEL_LOAD_ERROR="levelLoadError",t.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",t.LEVEL_SWITCH_ERROR="levelSwitchError",t.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",t.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",t.FRAG_LOAD_ERROR="fragLoadError",t.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",t.FRAG_DECRYPT_ERROR="fragDecryptError",t.FRAG_PARSING_ERROR="fragParsingError",t.REMUX_ALLOC_ERROR="remuxAllocError",t.KEY_LOAD_ERROR="keyLoadError",t.KEY_LOAD_TIMEOUT="keyLoadTimeOut",t.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",t.BUFFER_APPEND_ERROR="bufferAppendError",t.BUFFER_APPENDING_ERROR="bufferAppendingError",t.BUFFER_STALLED_ERROR="bufferStalledError",t.BUFFER_FULL_ERROR="bufferFullError",t.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",t.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",t.INTERNAL_EXCEPTION="internalException"}(i||(i={}));function a(t,e,s,r){void 0===s&&(s=1),void 0===r&&(r=!1);var i=t*e*s;return r?Math.round(i):i}function n(t,e){return void 0===e&&(e=!1),a(t,1e3,1/9e4,e)}function o(t,e){return void 0===e&&(e=1),a(t,9e4,1/e)}const l=/^(\d+)x(\d+)$/,d=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class c{constructor(t){"string"==typeof t&&(t=c.parseAttrList(t));for(let e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(1&e.length?"0":"")+e;const s=new Uint8Array(e.length/2);for(let t=0;t<e.length/2;t++)s[t]=parseInt(e.slice(2*t,2*t+2),16);return s}return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}enumeratedString(t){return this[t]}decimalResolution(t){const e=l.exec(this[t]);if(null!==e)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e,s={};for(d.lastIndex=0;null!==(e=d.exec(t));){let t=e[2],r='"';0===t.indexOf(r)&&t.lastIndexOf(r)===t.length-1&&(t=t.slice(1,-1)),s[e[1]]=t}return s}}var u={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};function h(){return"undefined"==typeof window?self:window}function m(t,a,n,o){let l,d,c,u,h,m="Android".toLowerCase(),f=o,p=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(l=1+((192&a[n+2])>>>6),d=(60&a[n+2])>>>2,!(d>p.length-1))return u=(1&a[n+2])<<2,u|=(192&a[n+3])>>>6,e.log(`manifest codec:${o},ADTS data:type:${l},sampleingIndex:${d}[${p[d]}Hz],channelConfig:${u}`),/firefox/i.test(m)?d>=6?(l=5,h=new Array(4),c=d-3):(l=2,h=new Array(2),c=d):-1!==m.indexOf("android")?(l=2,h=new Array(2),c=d):(l=5,h=new Array(4),o&&(-1!==o.indexOf("mp4a.40.29")||-1!==o.indexOf("mp4a.40.5"))||!o&&d>=6?c=d-3:((o&&-1!==o.indexOf("mp4a.40.2")&&(d>=6&&1===u||/vivaldi/i.test(m))||!o&&1===u)&&(l=2,h=new Array(2)),c=d)),h[0]=l<<3,h[0]|=(14&d)>>1,h[1]|=(1&d)<<7,h[1]|=u<<3,5===l&&(h[1]|=(14&c)>>1,h[2]=(1&c)<<7,h[2]|=8,h[3]=0),{config:h,samplerate:p[d],channelCount:u,codec:"mp4a.40."+l,manifestCodec:f};t.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:i.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${d}`})}function f(t,e){return 255===t[e]&&240==(246&t[e+1])}function p(t,e){return 1&t[e+1]?7:9}function g(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function y(t,e){return!!(e+1<t.length&&f(t,e))}function v(t){return 9216e4/t}function b(t,e,s,r,i){let a,n,o,l=t.length;if(a=p(t,e),n=g(t,e),n-=a,n>0&&e+a+n<=l)return o=s+r*i,{headerLength:a,frameLength:n,stamp:o}}const S={getAudioConfig:m,isHeaderPattern:f,getHeaderLength:p,getFullFrameLength:g,isHeader:y,probe:function(t,e){if(y(t,e)){let s=p(t,e);if(e+s>=t.length)return!1;let r=g(t,e);if(r<=s)return!1;let i=e+r;if(i===t.length||i+1<t.length&&f(t,i))return!0}return!1},initTrackConfig:function(t,s,r,i,a){if(!t.samplerate){let n=m(s,r,i,a);t.config=n.config,t.samplerate=n.samplerate,t.channelCount=n.channelCount,t.codec=n.codec,t.manifestCodec=n.manifestCodec,e.log(`parsed codec:${t.codec},rate:${n.samplerate},nb channel:${n.channelCount}`)}},getFrameDuration:v,parseFrameHeader:b,appendFrame:function(t,e,s,r,i){let a=b(e,s,r,i,v(t.samplerate));if(a){let r=a.stamp,i=a.headerLength,n=a.frameLength,o={unit:e.subarray(s+i,s+i+n),pts:r,dts:r};return t.samples.push(o),{sample:o,length:n+i}}}},A={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],appendFrame:function(t,e,s,r,i){if(s+24>e.length)return;let a=this.parseHeader(e,s);if(a&&s+a.frameLength<=e.length){let n=r+i*(9e4*a.samplesPerFrame/a.sampleRate),o={unit:e.subarray(s,s+a.frameLength),pts:n,dts:n};return t.config=[],t.channelCount=a.channelCount,t.samplerate=a.sampleRate,t.samples.push(o),{sample:o,length:a.frameLength}}},parseHeader:function(t,e){let s=t[e+1]>>3&3,r=t[e+1]>>1&3,i=t[e+2]>>4&15,a=t[e+2]>>2&3,n=t[e+2]>>1&1;if(1!==s&&0!==i&&15!==i&&3!==a){let o=3===s?3-r:3===r?3:4,l=1e3*A.BitratesMap[14*o+i-1],d=3===s?0:2===s?1:2,c=A.SamplingRateMap[3*d+a],u=t[e+3]>>6==3?1:2,h=A.SamplesCoefficients[s][r],m=A.BytesInSlot[r],f=8*h*m;return{sampleRate:c,channelCount:u,frameLength:parseInt(h*l/c+n,10)*m,samplesPerFrame:f}}},isHeaderPattern:function(t,e){return 255===t[e]&&224==(224&t[e+1])&&0!=(6&t[e+1])},isHeader:function(t,e){return!!(e+1<t.length&&this.isHeaderPattern(t,e))},probe:function(t,e){if(e+1<t.length&&this.isHeaderPattern(t,e)){let s=4,r=this.parseHeader(t,e),i=s;r&&r.frameLength&&(i=r.frameLength);let a=e+i;if(a===t.length||a+1<t.length&&this.isHeaderPattern(t,a))return!0}return!1}};class T{constructor(t){this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let t=this.data,e=this.bytesAvailable,s=t.byteLength-e,r=new Uint8Array(4),i=Math.min(4,e);if(0===i)throw new Error("no bytes available");r.set(t.subarray(s,s+i)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i}skipBits(t){let e;this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(e=(t-=this.bitsAvailable)>>3,t-=e>>3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let s=Math.min(this.bitsAvailable,t),r=this.word>>>32-s;return t>32&&e.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=s,this.bitsAvailable>0?this.word<<=s:this.bytesAvailable>0&&this.loadWord(),s=t-s,s>0&&this.bitsAvailable?r<<s|this.readBits(s):r}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if(0!=(this.word&2147483648>>>t))return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let t=this.skipLZ();return this.readBits(t+1)-1}readEG(){let t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e,s,r=8,i=8;for(e=0;e<t;e++)0!==i&&(s=this.readEG(),i=(r+s+256)%256),r=0===i?r:i}readSPS(){let t,e,s,r,i,a,n,o,l,d=0,c=0,u=0,h=0,m=this.readUByte.bind(this),f=this.readBits.bind(this),p=this.readUEG.bind(this),g=this.readBoolean.bind(this),y=this.skipBits.bind(this),v=this.skipEG.bind(this),b=this.skipUEG.bind(this),S=this.skipScalingList.bind(this);if(m(),t=m(),e=f(5),y(3),s=m(),b(),100===t||110===t||122===t||244===t||44===t||83===t||86===t||118===t||128===t){let t=p();if(3===t&&y(1),b(),b(),y(1),g())for(o=3!==t?8:12,l=0;l<o;l++)g()&&S(l<6?16:64)}b();let A=p();if(0===A)p();else if(1===A)for(y(1),v(),v(),r=p(),l=0;l<r;l++)v();b(),y(1),i=p(),a=p(),n=f(1),0===n&&y(1),y(1),g()&&(d=p(),c=p(),u=p(),h=p());let T=[1,1];if(g()&&g()){switch(m()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[m()<<8|m(),m()<<8|m()]}}return{width:Math.ceil(16*(i+1)-2*d-2*c),height:(2-n)*(a+1)*16-(n?2:4)*(u+h),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class w{constructor(t,e){this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class _{constructor(t,e){this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class E{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(t){let e=new DataView(t),s=new Uint32Array(4);for(let t=0;t<4;t++)s[t]=e.getUint32(4*t);return s}initTable(){let t=this.sBox,e=this.invSBox,s=this.subMix,r=s[0],i=s[1],a=s[2],n=s[3],o=this.invSubMix,l=o[0],d=o[1],c=o[2],u=o[3],h=new Uint32Array(256),m=0,f=0,p=0;for(p=0;p<256;p++)h[p]=p<128?p<<1:p<<1^283;for(p=0;p<256;p++){let s=f^f<<1^f<<2^f<<3^f<<4;s=s>>>8^255&s^99,t[m]=s,e[s]=m;let o=h[m],p=h[o],g=h[p],y=257*h[s]^16843008*s;r[m]=y<<24|y>>>8,i[m]=y<<16|y>>>16,a[m]=y<<8|y>>>24,n[m]=y,y=16843009*g^65537*p^257*o^16843008*m,l[s]=y<<24|y>>>8,d[s]=y<<16|y>>>16,c[s]=y<<8|y>>>24,u[s]=y,m?(m=o^h[h[h[g^o]]],f^=h[h[f]]):m=f=1}}expandKey(t){let e=this.uint8ArrayToUint32Array_(t),s=!0,r=0;for(;r<e.length&&s;)s=e[r]===this.key[r],r++;if(s)return;this.key=e;let i=this.keySize=e.length;if(4!==i&&6!==i&&8!==i)throw new Error("Invalid aes key size="+i);let a,n,o,l,d=this.ksRows=4*(i+6+1),c=this.keySchedule=new Uint32Array(d),u=this.invKeySchedule=new Uint32Array(d),h=this.sBox,m=this.rcon,f=this.invSubMix,p=f[0],g=f[1],y=f[2],v=f[3];for(a=0;a<d;a++)a<i?o=c[a]=e[a]:(l=o,a%i==0?(l=l<<8|l>>>24,l=h[l>>>24]<<24|h[l>>>16&255]<<16|h[l>>>8&255]<<8|h[255&l],l^=m[a/i|0]<<24):i>6&&a%i==4&&(l=h[l>>>24]<<24|h[l>>>16&255]<<16|h[l>>>8&255]<<8|h[255&l]),c[a]=o=(c[a-i]^l)>>>0);for(n=0;n<d;n++)a=d-n,l=3&n?c[a]:c[a-4],u[n]=n<4||a<=4?l:p[h[l>>>24]]^g[h[l>>>16&255]]^y[h[l>>>8&255]]^v[h[255&l]],u[n]=u[n]>>>0}networkToHostOrderSwap(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24}decrypt(t,e,s,r){let i,a,n,o,l,d,c,u,h,m,f,p,g,y,v=this.keySize+6,b=this.invKeySchedule,S=this.invSBox,A=this.invSubMix,T=A[0],w=A[1],_=A[2],E=A[3],x=this.uint8ArrayToUint32Array_(s),k=x[0],D=x[1],L=x[2],I=x[3],R=new Int32Array(t),M=new Int32Array(R.length),C=this.networkToHostOrderSwap;for(;e<R.length;){for(h=C(R[e]),m=C(R[e+1]),f=C(R[e+2]),p=C(R[e+3]),l=h^b[0],d=p^b[1],c=f^b[2],u=m^b[3],g=4,y=1;y<v;y++)i=T[l>>>24]^w[d>>16&255]^_[c>>8&255]^E[255&u]^b[g],a=T[d>>>24]^w[c>>16&255]^_[u>>8&255]^E[255&l]^b[g+1],n=T[c>>>24]^w[u>>16&255]^_[l>>8&255]^E[255&d]^b[g+2],o=T[u>>>24]^w[l>>16&255]^_[d>>8&255]^E[255&c]^b[g+3],l=i,d=a,c=n,u=o,g+=4;i=S[l>>>24]<<24^S[d>>16&255]<<16^S[c>>8&255]<<8^S[255&u]^b[g],a=S[d>>>24]<<24^S[c>>16&255]<<16^S[u>>8&255]<<8^S[255&l]^b[g+1],n=S[c>>>24]<<24^S[u>>16&255]<<16^S[l>>8&255]<<8^S[255&d]^b[g+2],o=S[u>>>24]<<24^S[l>>16&255]<<16^S[d>>8&255]<<8^S[255&c]^b[g+3],g+=3,M[e]=C(i^k),M[e+1]=C(o^D),M[e+2]=C(n^L),M[e+3]=C(a^I),k=h,D=m,L=f,I=p,e+=4}return r?function(t){const e=t.byteLength,s=e&&new DataView(t).getUint8(e-1);return s?t.slice(0,e-s):t}(M.buffer):M.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}const x=h();class k{constructor(t,e,{removePKCS7Padding:s=!0}={}){if(this.logEnabled=!0,this.observer=t,this.config=e,this.removePKCS7Padding=s,s)try{const t=x.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch(t){}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(t,s,r,i){if(this.disableWebCrypto&&this.config.enableSoftwareAES){this.logEnabled&&(e.log("JS AES decrypt"),this.logEnabled=!1);let a=this.decryptor;a||(this.decryptor=a=new E),a.expandKey(s),i(a.decrypt(t,0,r,this.removePKCS7Padding))}else{this.logEnabled&&(e.log("WebCrypto AES decrypt"),this.logEnabled=!1);const a=this.subtle;this.key!==s&&(this.key=s,this.fastAesKey=new _(a,s)),this.fastAesKey.expandKey().then((e=>{new w(a,r).decrypt(t,e).catch((e=>{this.onWebCryptoError(e,t,s,r,i)})).then((t=>{i(t)}))})).catch((e=>{this.onWebCryptoError(e,t,s,r,i)}))}}onWebCryptoError(t,a,n,o,l){this.config.enableSoftwareAES?(e.log("WebCrypto Error, disable WebCrypto API"),this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(a,n,o,l)):(e.error(`decrypting error : ${t.message}`),this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:i.FRAG_DECRYPT_ERROR,fatal:!0,reason:t.message}))}destroy(){let t=this.decryptor;t&&(t.destroy(),this.decryptor=void 0)}}class D{constructor(t,e,s,r){this.decryptdata=s,this.discardEPB=r,this.decrypter=new k(t,e,{removePKCS7Padding:!1})}decryptBuffer(t,e){this.decrypter.decrypt(t,this.decryptdata.key.buffer,this.decryptdata.iv.buffer,e)}decryptAacSample(t,e,s,r){let i=t[e].unit,a=i.subarray(16,i.length-i.length%16),n=a.buffer.slice(a.byteOffset,a.byteOffset+a.length),o=this;this.decryptBuffer(n,(function(a){a=new Uint8Array(a),i.set(a,16),r||o.decryptAacSamples(t,e+1,s)}))}decryptAacSamples(t,e,s){for(;;e++){if(e>=t.length)return void s();if(t[e].unit.length<32)continue;let r=this.decrypter.isSync();if(this.decryptAacSample(t,e,s,r),!r)return}}getAvcEncryptedData(t){let e=16*Math.floor((t.length-48)/160)+16,s=new Int8Array(e),r=0;for(let e=32;e<=t.length-16;e+=160,r+=16)s.set(t.subarray(e,e+16),r);return s}getAvcDecryptedUnit(t,e){e=new Uint8Array(e);let s=0;for(let r=32;r<=t.length-16;r+=160,s+=16)t.set(e.subarray(s,s+16),r);return t}decryptAvcSample(t,e,s,r,i,a){let n=this.discardEPB(i.data),o=this.getAvcEncryptedData(n),l=this;this.decryptBuffer(o.buffer,(function(o){i.data=l.getAvcDecryptedUnit(n,o),a||l.decryptAvcSamples(t,e,s+1,r)}))}decryptAvcSamples(t,e,s,r){for(;;e++,s=0){if(e>=t.length)return void r();let i=t[e].units;for(;!(s>=i.length);s++){let a=i[s];if(a.length<=48||1!==a.type&&5!==a.type)continue;let n=this.decrypter.isSync();if(this.decryptAvcSample(t,e,s,r,a,n),!n)return}}}}const L={video:1,audio:2,id3:3,text:4};class I{constructor(t,e,s,r){this.observer=t,this.config=s,this.typeSupported=r,this.remuxer=e,this.sampleAes=null,this.pmtUnknownTypes={}}setDecryptData(t){null!=t&&null!=t.key&&"SAMPLE-AES"===t.method?this.sampleAes=new D(this.observer,this.config,t,this.discardEPB):this.sampleAes=null}static probe(t){const s=I._syncOffset(t);return!(s<0)&&(s&&e.warn(`MPEG2-TS detected but first sync word found @ offset ${s}, junk ahead ?`),!0)}static _syncOffset(t){const e=Math.min(1e3,t.length-564);let s=0;for(;s<e;){if(71===t[s]&&71===t[s+188]&&71===t[s+376])return s;s++}return-1}static createTrack(t,e){return{container:"video"===t||"audio"===t?"video/mp2t":void 0,type:t,id:L[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:"video"===t?0:void 0,isAAC:"audio"===t||void 0,duration:"audio"===t?e:void 0}}resetInitSegment(t,e,s,r){this.pmtParsed=!1,this._pmtId=-1,this.pmtUnknownTypes={},this._avcTrack=I.createTrack("video",r),this._audioTrack=I.createTrack("audio",r),this._id3Track=I.createTrack("id3",r),this._txtTrack=I.createTrack("text",r),this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=e,this.videoCodec=s,this._duration=r}resetTimeStamp(){}append(t,a,n,o){let l,d,c,u,h,m,f=t.length,p=!1;this.pmtUnknownTypes={},this.contiguous=n;let g=this.pmtParsed,y=this._avcTrack,v=this._audioTrack,b=this._id3Track,S=y.pid,A=v.pid,T=b.pid,w=this._pmtId,_=y.pesData,E=v.pesData,x=b.pesData,k=this._parsePAT,D=this._parsePMT.bind(this),L=this._parsePES,R=this._parseAVCPES.bind(this),M=this._parseAACPES.bind(this),C=this._parseMPEGPES.bind(this),U=this._parseID3PES.bind(this);const P=I._syncOffset(t);for(f-=(f+P)%188,l=P;l<f;l+=188)if(71===t[l]){if(d=!!(64&t[l+1]),c=((31&t[l+1])<<8)+t[l+2],u=(48&t[l+3])>>4,u>1){if(h=l+5+t[l+4],h===l+188)continue}else h=l+4;switch(c){case S:d&&(_&&(m=L(_))&&R(m,!1),_={data:[],size:0}),_&&(_.data.push(t.subarray(h,l+188)),_.size+=l+188-h);break;case A:d&&(E&&(m=L(E))&&(v.isAAC?M(m):C(m)),E={data:[],size:0}),E&&(E.data.push(t.subarray(h,l+188)),E.size+=l+188-h);break;case T:d&&(x&&(m=L(x))&&U(m),x={data:[],size:0}),x&&(x.data.push(t.subarray(h,l+188)),x.size+=l+188-h);break;case 0:d&&(h+=t[h]+1),w=this._pmtId=k(t,h);break;case w:d&&(h+=t[h]+1);let s=D(t,h,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,null!=this.sampleAes);S=s.avc,S>0&&(y.pid=S),A=s.audio,A>0&&(v.pid=A,v.isAAC=s.isAAC),T=s.id3,T>0&&(b.pid=T),p&&!g&&(e.log("reparse from beginning"),p=!1,l=P-188),g=this.pmtParsed=!0;break;case 17:case 8191:break;default:p=!0}}else this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:i.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});_&&(m=L(_))?(R(m,!0),y.pesData=null):y.pesData=_,E&&(m=L(E))?(v.isAAC?M(m):C(m),v.pesData=null):(E&&E.size&&e.log("last AAC PES packet truncated,might overlap between fragments"),v.pesData=E),x&&(m=L(x))?(U(m),b.pesData=null):b.pesData=x,null==this.sampleAes?this.remuxer.remux(v,y,b,this._txtTrack,a,n,o):this.decryptAndRemux(v,y,b,this._txtTrack,a,n,o)}decryptAndRemux(t,e,s,r,i,a,n){if(t.samples&&t.isAAC){let o=this;this.sampleAes.decryptAacSamples(t.samples,0,(function(){o.decryptAndRemuxAvc(t,e,s,r,i,a,n)}))}else this.decryptAndRemuxAvc(t,e,s,r,i,a,n)}decryptAndRemuxAvc(t,e,s,r,i,a,n){if(e.samples){let o=this;this.sampleAes.decryptAvcSamples(e.samples,0,0,(function(){o.remuxer.remux(t,e,s,r,i,a,n)}))}else this.remuxer.remux(t,e,s,r,i,a,n)}destroy(){this._initPTS=this._initDTS=void 0,this._duration=0}_parsePAT(t,e){return(31&t[e+10])<<8|t[e+11]}_trackUnknownPmt(t,s,r){const i=this.pmtUnknownTypes[t]||0;return 0===i&&(this.pmtUnknownTypes[t]=0,s.call(e,r)),this.pmtUnknownTypes[t]++,i}_parsePMT(t,s,r,i){let a,n,o,l,d={audio:-1,avc:-1,id3:-1,isAAC:!0};for(a=(15&t[s+1])<<8|t[s+2],n=s+3+a-4,o=(15&t[s+10])<<8|t[s+11],s+=12+o;s<n;){switch(l=(31&t[s+1])<<8|t[s+2],t[s]){case 207:if(!i){this._trackUnknownPmt(t[s],e.warn,"ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===d.audio&&(d.audio=l);break;case 21:-1===d.id3&&(d.id3=l);break;case 219:if(!i){this._trackUnknownPmt(t[s],e.warn,"H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===d.avc&&(d.avc=l);break;case 3:case 4:r?-1===d.audio&&(d.audio=l,d.isAAC=!1):this._trackUnknownPmt(t[s],e.warn,"MPEG audio found, not supported in this browser");break;case 36:this._trackUnknownPmt(t[s],e.warn,"Unsupported HEVC stream type found");break;default:this._trackUnknownPmt(t[s],e.log,"Unknown stream type:"+t[s])}s+=5+((15&t[s+3])<<8|t[s+4])}return d}_parsePES(t){let s,r,i,a,n,o,l,d,c,u=0,h=t.data;if(!t||0===t.size)return null;for(;h[0].length<19&&h.length>1;){let t=new Uint8Array(h[0].length+h[1].length);t.set(h[0]),t.set(h[1],h[0].length),h[0]=t,h.splice(1,1)}if(s=h[0],i=(s[0]<<16)+(s[1]<<8)+s[2],1===i){if(a=(s[4]<<8)+s[5],a&&a>t.size-6)return null;if(r=s[7],192&r&&(l=536870912*(14&s[9])+4194304*(255&s[10])+16384*(254&s[11])+128*(255&s[12])+(254&s[13])/2,64&r?(d=536870912*(14&s[14])+4194304*(255&s[15])+16384*(254&s[16])+128*(255&s[17])+(254&s[18])/2,l-d>54e5&&(e.warn(`${Math.round((l-d)/9e4)}s delta between PTS and DTS, align them`),l=d)):d=l),n=s[8],c=n+9,t.size<=c)return null;t.size-=c,o=new Uint8Array(t.size);for(let t=0,e=h.length;t<e;t++){s=h[t];let e=s.byteLength;if(c){if(c>e){c-=e;continue}s=s.subarray(c),e-=c,c=0}o.set(s,u),u+=e}return a&&(a-=n+3),{data:o,pts:l,dts:d,len:a}}return null}pushAccesUnit(t,s){if(t.units.length&&t.frame){const e=s.samples,r=e.length;if(isNaN(t.pts)){if(!r)return void s.dropped++;{const s=e[r-1];t.pts=s.pts,t.dts=s.dts}}!this.config.forceKeyFrameOnDiscontinuity||!0===t.key||s.sps&&(r||this.contiguous)?(t.id=r,e.push(t)):s.dropped++}t.debug.length&&e.log(t.pts+"/"+t.dts+":"+t.debug)}_parseAVCPES(t,e){let s,r,i,a=this._avcTrack,n=this._parseAVCNALu(t.data),o=this.avcSample,l=!1,d=this.pushAccesUnit.bind(this),c=function(t,e,s,r){return{key:t,pts:e,dts:s,units:[],debug:r}};t.data=null,o&&n.length&&!a.audFound&&(d(o,a),o=this.avcSample=c(!1,t.pts,t.dts,"")),n.forEach((e=>{switch(e.type){case 1:r=!0,o||(o=this.avcSample=c(!0,t.pts,t.dts,"")),o.frame=!0;let f=e.data;if(l&&f.length>4){let t=new T(f).readSliceType();2!==t&&4!==t&&7!==t&&9!==t||(o.key=!0)}break;case 5:r=!0,o||(o=this.avcSample=c(!0,t.pts,t.dts,"")),o.key=!0,o.frame=!0;break;case 6:r=!0,s=new T(this.discardEPB(e.data)),s.readUByte();for(var n=0,u=0,h=!1,m=0;!h&&s.bytesAvailable>1;){n=0;do{n+=m=s.readUByte()}while(255===m);u=0;do{u+=m=s.readUByte()}while(255===m);if(4===n&&0!==s.bytesAvailable){if(h=!0,181===s.readUByte()){if(49===s.readUShort()){if(1195456820===s.readUInt()){if(3===s.readUByte()){let e=s.readUByte(),r=31&e,a=[e,s.readUByte()];for(i=0;i<r;i++)a.push(s.readUByte()),a.push(s.readUByte()),a.push(s.readUByte());this._insertSampleInOrder(this._txtTrack.samples,{type:3,pts:t.pts,bytes:a})}}}}}else if(5===n&&0!==s.bytesAvailable){if(h=!0,u>16){const e=[];for(i=0;i<16;i++)e.push(s.readUByte().toString(16)),3!==i&&5!==i&&7!==i&&9!==i||e.push("-");const r=u-16,a=new Uint8Array(r);for(i=0;i<r;i++)a[i]=s.readUByte();this._insertSampleInOrder(this._txtTrack.samples,{pts:t.pts,payloadType:n,uuid:e.join(""),userDataBytes:a,userData:q(a.buffer)})}}else if(u<s.bytesAvailable)for(i=0;i<u;i++)s.readUByte()}break;case 7:if(r=!0,l=!0,!a.sps){s=new T(e.data);let t=s.readSPS();a.width=t.width,a.height=t.height,a.pixelRatio=t.pixelRatio,a.sps=[e.data],a.duration=this._duration;let r=e.data.subarray(1,4),n="avc1.";for(i=0;i<3;i++){let t=r[i].toString(16);t.length<2&&(t="0"+t),n+=t}a.codec=n}break;case 8:r=!0,a.pps||(a.pps=[e.data]);break;case 9:r=!1,a.audFound=!0,o&&d(o,a),o=this.avcSample=c(!1,t.pts,t.dts,"");break;case 12:r=!1;break;default:r=!1,o&&(o.debug+="unknown NAL "+e.type+" ")}if(o&&r){o.units.push(e)}})),e&&o&&(d(o,a),this.avcSample=null)}_insertSampleInOrder(t,e){let s=t.length;if(s>0){if(e.pts>=t[s-1].pts)t.push(e);else for(let r=s-1;r>=0;r--)if(e.pts<t[r].pts){t.splice(r,0,e);break}}else t.push(e)}_getLastNalUnit(){let t,e=this.avcSample;if(!e||0===e.units.length){let t=this._avcTrack.samples;e=t[t.length-1]}if(e){let s=e.units;t=s[s.length-1]}return t}_parseAVCNALu(t){let e,s,r,i,a,n=0,o=t.byteLength,l=this._avcTrack,d=l.naluState||0,c=d,u=[],h=-1;for(-1===d&&(h=0,a=31&t[0],d=0,n=1);n<o;)if(e=t[n++],d)if(1!==d)if(e)if(1===e){if(h>=0)r={data:t.subarray(h,n-d-1),type:a},u.push(r);else{let e=this._getLastNalUnit();if(e&&(c&&n<=4-c&&e.state&&(e.data=e.data.subarray(0,e.data.byteLength-c)),s=n-d-1,s>0)){let r=new Uint8Array(e.data.byteLength+s);r.set(e.data,0),r.set(t.subarray(0,s),e.data.byteLength),e.data=r}}n<o?(i=31&t[n],h=n,a=i,d=0):d=-1}else d=0;else d=3;else d=e?0:2;else d=e?0:1;if(h>=0&&d>=0&&(r={data:t.subarray(h,o),type:a,state:d},u.push(r)),0===u.length){let e=this._getLastNalUnit();if(e){let s=new Uint8Array(e.data.byteLength+t.byteLength);s.set(e.data,0),s.set(t,e.data.byteLength),e.data=s}}return l.naluState=d,u}discardEPB(t){let e,s,r=t.byteLength,i=[],a=1;for(;a<r-2;)0===t[a]&&0===t[a+1]&&3===t[a+2]?(i.push(a+2),a+=2):a++;if(0===i.length)return t;e=r-i.length,s=new Uint8Array(e);let n=0;for(a=0;a<e;n++,a++)n===i[0]&&(n++,i.shift()),s[a]=t[n];return s}_parseAACPES(t){let a,n,o,l,d,c=this._audioTrack,u=t.data,h=t.pts,m=this.aacOverFlow,f=this.aacLastPTS;if(m){let t=new Uint8Array(m.byteLength+u.byteLength);t.set(m,0),t.set(u,m.byteLength),u=t}for(o=0,d=u.length;o<d-1&&!S.isHeader(u,o);o++);if(o>0&&o<d-1)o=0;else if(o){let t,a;if(o<d-1?(t=`AAC PES did not start with ADTS header,offset:${o}`,a=!1):(t="no ADTS header found in AAC PES",a=!0),e.warn(`parsing error:${t}`),this.observer.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:i.FRAG_PARSING_ERROR,fatal:a,reason:t}),a)return}if(S.initTrackConfig(c,this.observer,u,o,this.audioCodec),n=0,a=S.getFrameDuration(c.samplerate),m&&f){let t=f+a;Math.abs(t-h)>1&&(e.log(`AAC: align PTS for overlapping frames by ${Math.round((t-h)/90)}`),h=t)}for(;o<d;){if(S.isHeader(u,o)){if(o+5<d){const t=S.appendFrame(c,u,o,h,n);if(t){o+=t.length,l=t.sample.pts,n++;continue}}break}o++}m=o<d?u.subarray(o,d):null,this.aacOverFlow=m,this.aacLastPTS=l}_parseMPEGPES(t){let e=t.data,s=e.length,r=0,i=0,a=t.pts;for(;i<s;)if(A.isHeader(e,i)){let t=A.appendFrame(this._audioTrack,e,i,a,r);if(!t)break;i+=t.length,r++}else i++}_parseID3PES(t){this._id3Track.samples.push(t)}}class R{static getSilentFrame(t,e){if("mp4a.40.2"===t){if(1===e)return new Uint8Array([0,200,0,128,35,128]);if(2===e)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===e)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}const M=Math.pow(2,32)-1;class C{static init(){let t;for(t in C.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},C.types)C.types.hasOwnProperty(t)&&(C.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);let e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);C.HDLR_TYPES={video:e,audio:s};let r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),i=new Uint8Array([0,0,0,0,0,0,0,0]);C.STTS=C.STSC=C.STCO=i,C.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),C.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),C.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),C.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let a=new Uint8Array([105,115,111,109]),n=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);C.FTYP=C.box(C.types.ftyp,a,o,a,n),C.DINF=C.box(C.types.dinf,C.box(C.types.dref,r))}static box(t){let e,s=Array.prototype.slice.call(arguments,1),r=8,i=s.length,a=i;for(;i--;)r+=s[i].byteLength;for(e=new Uint8Array(r),e[0]=r>>24&255,e[1]=r>>16&255,e[2]=r>>8&255,e[3]=255&r,e.set(t,4),i=0,r=8;i<a;i++)e.set(s[i],r),r+=s[i].byteLength;return e}static hdlr(t){return C.box(C.types.hdlr,C.HDLR_TYPES[t])}static mdat(t){return C.box(C.types.mdat,t)}static mdhd(t,e){e*=t;const s=Math.floor(e/(M+1)),r=Math.floor(e%(M+1));return C.box(C.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,s>>24,s>>16&255,s>>8&255,255&s,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(t){return C.box(C.types.mdia,C.mdhd(t.timescale,t.duration),C.hdlr(t.type),C.minf(t))}static mfhd(t){return C.box(C.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?C.box(C.types.minf,C.box(C.types.smhd,C.SMHD),C.DINF,C.stbl(t)):C.box(C.types.minf,C.box(C.types.vmhd,C.VMHD),C.DINF,C.stbl(t))}static moof(t,e,s){return C.box(C.types.moof,C.mfhd(t),C.traf(s,e))}static moov(t){let e=t.length,s=[];for(;e--;)s[e]=C.trak(t[e]);return C.box.apply(null,[C.types.moov,C.mvhd(t[0].timescale,t[0].duration)].concat(s).concat(C.mvex(t)))}static mvex(t){let e=t.length,s=[];for(;e--;)s[e]=C.trex(t[e]);return C.box.apply(null,[C.types.mvex].concat(s))}static mvhd(t,e){e*=t;const s=Math.floor(e/(M+1)),r=Math.floor(e%(M+1));let i=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,s>>24,s>>16&255,s>>8&255,255&s,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return C.box(C.types.mvhd,i)}static sdtp(t){let e,s,r=t.samples||[],i=new Uint8Array(4+r.length);for(s=0;s<r.length;s++)e=r[s].flags,i[s+4]=e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy;return C.box(C.types.sdtp,i)}static stbl(t){return C.box(C.types.stbl,C.stsd(t),C.box(C.types.stts,C.STTS),C.box(C.types.stsc,C.STSC),C.box(C.types.stsz,C.STSZ),C.box(C.types.stco,C.STCO))}static avc1(t){let e,s,r,i=[],a=[];for(e=0;e<t.sps.length;e++)s=t.sps[e],r=s.byteLength,i.push(r>>>8&255),i.push(255&r),i=i.concat(Array.prototype.slice.call(s));for(e=0;e<t.pps.length;e++)s=t.pps[e],r=s.byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(s));let n=C.box(C.types.avcC,new Uint8Array([1,i[3],i[4],i[5],255,224|t.sps.length].concat(i).concat([t.pps.length]).concat(a))),o=t.width,l=t.height,d=t.pixelRatio[0],c=t.pixelRatio[1];return C.box(C.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,C.box(C.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),C.box(C.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(t){let e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static mp4a(t){let e=t.samplerate;return C.box(C.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]),C.box(C.types.esds,C.esds(t)))}static mp3(t){let e=t.samplerate;return C.box(C.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]))}static stsd(t){return"audio"===t.type?t.isAAC||"mp3"!==t.codec?C.box(C.types.stsd,C.STSD,C.mp4a(t)):C.box(C.types.stsd,C.STSD,C.mp3(t)):C.box(C.types.stsd,C.STSD,C.avc1(t))}static tkhd(t){let e=t.id,s=t.duration*t.timescale,r=t.width,i=t.height,a=Math.floor(s/(M+1)),n=Math.floor(s%(M+1));return C.box(C.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,i>>8&255,255&i,0,0]))}static traf(t,e){let s=C.sdtp(t),r=t.id,i=Math.floor(e/(M+1)),a=Math.floor(e%(M+1));return C.box(C.types.traf,C.box(C.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),C.box(C.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,a>>24,a>>16&255,a>>8&255,255&a])),C.trun(t,s.length+16+20+8+16+8+8),s)}static trak(t){return t.duration=t.duration||4294967295,C.box(C.types.trak,C.tkhd(t),C.mdia(t))}static trex(t){let e=t.id;return C.box(C.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){let s,r,i,a,n,o,l=t.samples||[],d=l.length,c=12+16*d,u=new Uint8Array(c);for(e+=8+c,u.set([0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,255&d,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),s=0;s<d;s++)r=l[s],i=r.duration,a=r.size,n=r.flags,o=r.cts,u.set([i>>>24&255,i>>>16&255,i>>>8&255,255&i,a>>>24&255,a>>>16&255,a>>>8&255,255&a,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,61440&n.degradPrio,15&n.degradPrio,o>>>24&255,o>>>16&255,o>>>8&255,255&o],12+16*s);return C.box(C.types.trun,u)}static initSegment(t){C.types||C.init();let e,s=C.moov(t);return e=new Uint8Array(C.FTYP.byteLength+s.byteLength),e.set(C.FTYP),e.set(s,C.FTYP.byteLength),e}}const U=o(10),P=o(.2);let O,B=null;function F(t,e){let s;if(void 0===e)return t;for(s=e<t?-8589934592:8589934592;Math.abs(t-e)>4294967296;)t+=s;return t}class N{constructor(t,e){this.observer=t,this.remuxer=e}resetTimeStamp(t){this.initPTS=t}resetInitSegment(t,e,r,i){if(t&&t.byteLength){const a=this.initData=N.parseInitSegment(t);null==e&&(e="mp4a.40.5"),null==r&&(r="avc1.42e01e");const n={};a.audio&&a.video?n.audiovideo={container:"video/mp4",codec:e+","+r,initSegment:i?t:null}:(a.audio&&(n.audio={container:"audio/mp4",codec:e,initSegment:i?t:null}),a.video&&(n.video={container:"video/mp4",codec:r,initSegment:i?t:null})),this.observer.trigger(s.FRAG_PARSING_INIT_SEGMENT,{tracks:n})}else e&&(this.audioCodec=e),r&&(this.videoCodec=r)}static probe(t){return N.findBox({data:t,start:0,end:Math.min(t.length,16384)},["moof"]).length>0}static bin2str(t){return String.fromCharCode.apply(null,t)}static readUint16(t,e){t.data&&(e+=t.start,t=t.data);const s=t[e]<<8|t[e+1];return s<0?65536+s:s}static readUint32(t,e){t.data&&(e+=t.start,t=t.data);const s=t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3];return s<0?4294967296+s:s}static writeUint32(t,e,s){t.data&&(e+=t.start,t=t.data),t[e]=s>>24,t[e+1]=s>>16&255,t[e+2]=s>>8&255,t[e+3]=255&s}static findBox(t,e){let s,r,i,a,n,o,l,d=[];if(t.data?(o=t.start,a=t.end,t=t.data):(o=0,a=t.byteLength),!e.length)return null;for(s=o;s<a;)r=N.readUint32(t,s),i=N.bin2str(t.subarray(s+4,s+8)),l=r>1?s+r:a,i===e[0]&&(1===e.length?d.push({data:t,start:s+8,end:l}):(n=N.findBox({data:t,start:s+8,end:l},e.slice(1)),n.length&&(d=d.concat(n)))),s=l;return d}static parseSegmentIndex(t){const e=N.findBox(t,["moov"])[0],s=e?e.end:null;let r,i=0,a=N.findBox(t,["sidx"]);if(!a||!a[0])return null;r=[],a=a[0];const n=a.data[0];i=0===n?8:16;const o=N.readUint32(a,i);i+=4;i+=0===n?8:16,i+=2;let l=a.end+0;const d=N.readUint16(a,i);i+=2;for(let t=0;t<d;t++){let t=i;const e=N.readUint32(a,t);t+=4;const s=2147483647&e;if(1===(2147483648&e)>>>31)return;const n=N.readUint32(a,t);t+=4,r.push({referenceSize:s,subsegmentDuration:n,info:{duration:n/o,start:l,end:l+s-1}}),l+=s,t+=4,i=t}return{earliestPresentationTime:0,timescale:o,version:n,referencesCount:d,references:r,moovEndOffset:s}}static parseInitSegment(t){let s=[];return N.findBox(t,["moov","trak"]).forEach((t=>{const r=N.findBox(t,["tkhd"])[0];if(r){let i=r.data[r.start],a=0===i?12:20,n=N.readUint32(r,a);const o=N.findBox(t,["mdia","mdhd"])[0];if(o){i=o.data[o.start],a=0===i?12:20;const r=N.readUint32(o,a),l=N.findBox(t,["mdia","hdlr"])[0];if(l){let i={soun:"audio",vide:"video"}[N.bin2str(l.data.subarray(l.start+8,l.start+12))];if(i){let a=N.findBox(t,["mdia","minf","stbl","stsd"]);if(a.length){a=a[0];let t=N.bin2str(a.data.subarray(a.start+12,a.start+16));e.log(`MP4Demuxer:${i}:${t} found`)}s[n]={timescale:r,type:i},s[i]={timescale:r,id:n}}}}}})),s}static getStartDTS(t,e){let s,r,i;return s=N.findBox(e,["moof","traf"]),r=[].concat.apply([],s.map((function(e){return N.findBox(e,["tfhd"]).map((function(s){let r,i,a;return r=N.readUint32(s,4),i=t[r].timescale||9e4,a=N.findBox(e,["tfdt"]).map((function(t){let e,s;return e=t.data[t.start],s=N.readUint32(t,4),1===e&&(s*=Math.pow(2,32),s+=N.readUint32(t,8)),s}))[0],a/i}))}))),i=Math.min.apply(null,r),isFinite(i)?i:0}static offsetStartDTS(t,e,s){N.findBox(e,["moof","traf"]).map((function(e){return N.findBox(e,["tfhd"]).map((function(r){let i=N.readUint32(r,4),a=t[i].timescale||9e4;N.findBox(e,["tfdt"]).map((function(t){let e=t.data[t.start],r=N.readUint32(t,4);if(0===e)N.writeUint32(t,4,r-s*a);else{r*=Math.pow(2,32),r+=N.readUint32(t,8),r-=s*a,r=Math.max(r,0);const e=Math.floor(r/(M+1)),i=Math.floor(r%(M+1));N.writeUint32(t,4,e),N.writeUint32(t,8,i)}}))}))}))}append(t,e,r,i){let a=this.initData;a||(this.resetInitSegment(t,this.audioCodec,this.videoCodec,!1),a=this.initData);let n,o=this.initPTS;if(void 0===o){let r=N.getStartDTS(a,t);this.initPTS=o=r-e,this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o})}N.offsetStartDTS(a,t,o),n=N.getStartDTS(a,t),this.remuxer.remux(a.audio,a.video,null,null,n,r,i,t)}destroy(){}}class z{static isHeader(t,e){return e+10<=t.length&&73===t[e]&&68===t[e+1]&&51===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128}static isFooter(t,e){return e+10<=t.length&&51===t[e]&&68===t[e+1]&&73===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128}static getID3Data(t,e){const s=e;let r=0;for(;z.isHeader(t,e);){r+=10;r+=z._readSize(t,e+6),z.isFooter(t,e+10)&&(r+=10),e+=r}if(r>0)return t.subarray(s,s+r)}static _readSize(t,e){let s=0;return s=(127&t[e])<<21,s|=(127&t[e+1])<<14,s|=(127&t[e+2])<<7,s|=127&t[e+3],s}static getTimeStamp(t){const e=z.getID3Frames(t);for(let t=0;t<e.length;t++){const s=e[t];if(z.isTimeStampFrame(s))return z._readTimeStamp(s)}}static isTimeStampFrame(t){return t&&"PRIV"===t.key&&"com.apple.streaming.transportStreamTimestamp"===t.info}static _getFrameData(t){const e=String.fromCharCode(t[0],t[1],t[2],t[3]),s=z._readSize(t,4);return{type:e,size:s,data:t.subarray(10,10+s)}}static getID3Frames(t){let e=0;const s=[];for(;z.isHeader(t,e);){const r=z._readSize(t,e+6);e+=10;const i=e+r;for(;e+8<i;){const r=z._getFrameData(t.subarray(e)),i=z._decodeFrame(r);i&&s.push(i),e+=r.size+10}z.isFooter(t,e)&&(e+=10)}return s}static _decodeFrame(t){return"PRIV"===t.type?z._decodePrivFrame(t):"T"===t.type[0]?z._decodeTextFrame(t):"W"===t.type[0]?z._decodeURLFrame(t):void 0}static _readTimeStamp(t){if(8===t.data.byteLength){const e=new Uint8Array(t.data),s=1&e[3];let r=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return r/=45,s&&(r+=47721858.84),Math.round(r)}}static _decodePrivFrame(t){if(t.size<2)return;const e=z._utf8ArrayToStr(t.data,!0),s=new Uint8Array(t.data.subarray(e.length+1));return{key:t.type,info:e,data:s.buffer}}static _decodeTextFrame(t){if(!(t.size<2)){if("TXXX"===t.type){let e=1;const s=z._utf8ArrayToStr(t.data.subarray(e),!0);e+=s.length+1;const r=z._utf8ArrayToStr(t.data.subarray(e));return{key:t.type,info:s,data:r}}{const e=z._utf8ArrayToStr(t.data.subarray(1));return{key:t.type,data:e}}}}static _decodeURLFrame(t){if("WXXX"===t.type){if(t.size<2)return;let e=1;const s=z._utf8ArrayToStr(t.data.subarray(e),!0);e+=s.length+1;const r=z._utf8ArrayToStr(t.data.subarray(e));return{key:t.type,info:s,data:r}}{const e=z._utf8ArrayToStr(t.data);return{key:t.type,data:e}}}static _utf8ArrayToStr(t,e=!1){const s=G();if(s){const r=s.decode(t);if(e){const t=r.indexOf("\0");return-1!==t?r.substring(0,t):r}return r.replace(/\0/g,"")}const r=t.length;let i,a,n,o="",l=0;for(;l<r;){if(i=t[l++],0===i&&e)return o;if(0!==i&&3!==i)switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:a=t[l++],o+=String.fromCharCode((31&i)<<6|63&a);break;case 14:a=t[l++],n=t[l++],o+=String.fromCharCode((15&i)<<12|(63&a)<<6|(63&n)<<0)}}return o}}function G(){const t=h();return O||void 0===t.TextDecoder||(O=new t.TextDecoder("utf-8")),O}const q=z._utf8ArrayToStr;class H{constructor(t){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=t,this.version=null}get hasProgramDateTime(){return!(!this.fragments[0]||!Number.isFinite(this.fragments[0].programDateTime))}}var V,$=function(){function t(t,e){this._uri=null,this.method=null,this.key=null,this.iv=null,this.baseuri=t,this.reluri=e}return Object.defineProperty(t.prototype,"uri",{get:function(){return!this._uri&&this.reluri&&(this._uri=URLToolkit.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri},enumerable:!1,configurable:!0}),t}();!function(t){t.AUDIO="audio",t.VIDEO="video"}(V||(V={}));var j=function(){function t(){var t;this._url=null,this._byteRange=null,this._decryptdata=null,this._elementaryStreams=((t={})[V.AUDIO]=!1,t[V.VIDEO]=!1,t),this.deltaPTS=0,this.rawProgramDateTime=null,this.programDateTime=null,this.title=null,this.tagList=[],this.sn=0,this.urlId=0,this.level=0}return t.prototype.setByteRange=function(t,e){var s=t.split("@",2),r=[];1===s.length?r[0]=e?e.byteRangeEndOffset:0:r[0]=parseInt(s[1]),r[1]=parseInt(s[0])+r[0],this._byteRange=r},Object.defineProperty(t.prototype,"url",{get:function(){return!this._url&&this.relurl&&(this._url=URLToolkit.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url},set:function(t){this._url=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteRange",{get:function(){return this._byteRange?this._byteRange:[]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteRangeStartOffset",{get:function(){return this.byteRange[0]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"byteRangeEndOffset",{get:function(){return this.byteRange[1]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"decryptdata",{get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var t=this.sn;"number"!=typeof t&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&e.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),t=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,t)}return this._decryptdata},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"endProgramDateTime",{get:function(){if(null===this.programDateTime)return null;if(!Number.isFinite(this.programDateTime))return null;var t=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"encrypted",{get:function(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)},enumerable:!1,configurable:!0}),t.prototype.addElementaryStream=function(t){this._elementaryStreams[t]=!0},t.prototype.hasElementaryStream=function(t){return!0===this._elementaryStreams[t]},t.prototype.createInitializationVector=function(t){for(var e=new Uint8Array(16),s=12;s<16;s++)e[s]=t>>8*(15-s)&255;return e},t.prototype.setDecryptDataFromLevelKey=function(t,e){var s=t;return(null==t?void 0:t.method)&&t.uri&&!t.iv&&((s=new $(t.baseuri,t.reluri)).method=t.method,s.iv=this.createInitializationVector(e)),s},t}(),K=/(?:#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-SESSION-DATA:([^\n\r]*)[\r\n]+)/g,X=/#EXT-X-MEDIA:(.*)/g,Y=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),W=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,Q=/\.(mp4|m4s|m4v|m4a)$/i,J=function(){function t(){}return t.findGroup=function(t,e){for(var s=0;s<t.length;s++){var r=t[s];if(r.id===e)return r}},t.convertAVC1ToAVCOTI=function(t){var e,s=t.split(".");return s.length>2?(e=s.shift()+".",e+=parseInt(s.shift()).toString(16),e+=("000"+parseInt(s.shift()).toString(16)).substr(-4)):e=t,e},t.resolve=function(t,e){return URLToolkit.buildAbsoluteURL(e,t,{alwaysNormalize:!0})},t.parseMasterPlaylist=function(e,s){var r,i=[],a={},n=!1;function o(t,e){["video","audio"].forEach((function(s){var r=t.filter((function(t){return function(t,e){var s=u[e];return!!s&&!0===s[t.slice(0,4)]}(t,s)}));if(r.length){var i=r.filter((function(t){return 0===t.lastIndexOf("avc1",0)||0===t.lastIndexOf("mp4a",0)}));e[s+"Codec"]=i.length>0?i[0]:r[0],t=t.filter((function(t){return-1===r.indexOf(t)}))}})),e.unknownCodecs=t}for(K.lastIndex=0;null!=(r=K.exec(e));)if(r[1]){var l={},d=l.attrs=new c(r[1]);l.url=t.resolve(r[2],s);var h=d.decimalResolution("RESOLUTION");h&&(l.width=h.width,l.height=h.height),l.bitrate=d.decimalInteger("AVERAGE-BANDWIDTH")||d.decimalInteger("BANDWIDTH"),l.name=d.NAME,o([].concat((d.CODECS||"").split(/[ ,]+/)),l),l.videoCodec&&-1!==l.videoCodec.indexOf("avc1")&&(l.videoCodec=t.convertAVC1ToAVCOTI(l.videoCodec)),i.push(l)}else if(r[3]){var m=new c(r[3]);m["DATA-ID"]&&(n=!0,a[m["DATA-ID"]]=m)}return{levels:i,sessionData:n?a:null}},t.parseMasterPlaylistMedia=function(e,s,r,i){var a;void 0===i&&(i=[]);var n=[],o=0;for(X.lastIndex=0;null!==(a=X.exec(e));){var l=new c(a[1]);if(l.TYPE===r){var d={attrs:l,id:o++,groupId:l["GROUP-ID"],instreamId:l["INSTREAM-ID"],name:l.NAME||l.LANGUAGE,type:r,default:"YES"===l.DEFAULT,autoselect:"YES"===l.AUTOSELECT,forced:"YES"===l.FORCED,lang:l.LANGUAGE};if(l.URI&&(d.url=t.resolve(l.URI,s)),i.length){var u=t.findGroup(i,d.groupId);d.audioCodec=u?u.codec:i[0].codec}n.push(d)}}return n},t.parseLevelPlaylist=function(t,s,r,i,a){var n,o,l,d=0,u=0,h=new H(s),m=0,f=null,p=new j,g=null;for(Y.lastIndex=0;null!==(n=Y.exec(t));){var y=n[1];if(y){p.duration=parseFloat(y);var v=(" "+n[2]).slice(1);p.title=v||null,p.tagList.push(v?["INF",y,v]:["INF",y])}else if(n[3]){if(Number.isFinite(p.duration)){var b=d++;p.type=i,p.start=u,l&&(p.levelkey=l),p.sn=b,p.level=r,p.cc=m,p.urlId=a,p.baseurl=s,p.relurl=(" "+n[3]).slice(1),Z(p,f),h.fragments.push(p),f=p,u+=p.duration,p=new j}}else if(n[4]){var S=(" "+n[4]).slice(1);f?p.setByteRange(S,f):p.setByteRange(S)}else if(n[5])p.rawProgramDateTime=(" "+n[5]).slice(1),p.tagList.push(["PROGRAM-DATE-TIME",p.rawProgramDateTime]),null===g&&(g=h.fragments.length);else{if(!(n=n[0].match(W))){e.warn("No matches on slow regex match for level playlist!");continue}for(o=1;o<n.length&&void 0===n[o];o++);var A=(" "+n[o+1]).slice(1),T=(" "+n[o+2]).slice(1);switch(n[o]){case"#":p.tagList.push(T?[A,T]:[A]);break;case"PLAYLIST-TYPE":h.type=A.toUpperCase();break;case"MEDIA-SEQUENCE":d=h.startSN=parseInt(A);break;case"TARGETDURATION":h.targetduration=parseFloat(A);break;case"VERSION":h.version=parseInt(A);break;case"EXTM3U":break;case"ENDLIST":h.live=!1;break;case"DIS":m++,p.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":m=parseInt(A);break;case"KEY":var w=new c(A),_=w.enumeratedString("METHOD"),E=w.URI,x=w.hexadecimalInteger("IV");if("com.apple.streamingkeydelivery"===(w.KEYFORMAT||"identity")){e.warn("Keyformat com.apple.streamingkeydelivery is not supported");continue}_&&(l=new $(s,E),E&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(_)>=0&&(l.method=_,l.key=null,l.iv=x));break;case"START":var k=new c(A).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(k)&&(h.startTimeOffset=k);break;case"MAP":var D=new c(A);p.relurl=D.URI,D.BYTERANGE&&p.setByteRange(D.BYTERANGE),p.baseurl=s,p.level=r,p.type=i,p.sn="initSegment",h.initSegment=p,(p=new j).rawProgramDateTime=h.initSegment.rawProgramDateTime;break;default:e.warn("line parsed but not handled: "+n)}}}return(p=f)&&!p.relurl&&(h.fragments.pop(),u-=p.duration),h.totalduration=u,h.averagetargetduration=u/h.fragments.length,h.endSN=d-1,h.startCC=h.fragments[0]?h.fragments[0].cc:0,h.endCC=m,!h.initSegment&&h.fragments.length&&h.fragments.every((function(t){return Q.test(t.relurl)}))&&(e.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(p=new j).relurl=h.fragments[0].relurl,p.baseurl=s,p.level=r,p.type=i,p.sn="initSegment",h.initSegment=p,h.needSidxRanges=!0),g&&function(t,e){for(var s=t[e],r=e-1;r>=0;r--){var i=t[r];i.programDateTime=s.programDateTime-1e3*i.duration,s=i}}(h.fragments,g),h},t}();function Z(t,e){t.rawProgramDateTime?t.programDateTime=Date.parse(t.rawProgramDateTime):(null==e?void 0:e.programDateTime)&&(t.programDateTime=e.endProgramDateTime),Number.isFinite(t.programDateTime)||(t.programDateTime=null,t.rawProgramDateTime=null)}Object.assign(t,{HlsEvents:s,Fragment:j,LevelKey:$,isCodecSupportedInMp4:function(t,e){return MediaSource.isTypeSupported((e||"video")+'/mp4;codecs="'+t+'"')},MpegAudio:A,M3U8Parser:J,AESDecryptor:E,TSDemuxer:I,MP4Demuxer:N,AACDemuxer:class{constructor(t,e,s){this.observer=t,this.config=s,this.remuxer=e}resetInitSegment(t,e,s,r){this._audioTrack={container:"audio/adts",type:"audio",id:0,sequenceNumber:0,isAAC:!0,samples:[],len:0,manifestCodec:e,duration:r,inputTimeScale:9e4}}resetTimeStamp(){}static probe(t){if(!t)return!1;let s=(z.getID3Data(t,0)||[]).length;for(let r=t.length;s<r;s++)if(S.probe(t,s))return e.log("ADTS sync word found !"),!0;return!1}append(t,s,r,i){let a=this._audioTrack,n=z.getID3Data(t,0)||[],o=z.getTimeStamp(n),l=Number.isFinite(o)?90*o:9e4*s,d=0,c=l,u=t.length,h=n.length,m=[{pts:c,dts:c,data:n}];for(;h<u-1;)if(S.isHeader(t,h)&&h+5<u){S.initTrackConfig(a,this.observer,t,h,a.manifestCodec);let s=S.appendFrame(a,t,h,l,d);if(!s){e.log("Unable to parse AAC frame");break}h+=s.length,c=s.sample.pts,d++}else z.isHeader(t,h)?(n=z.getID3Data(t,h),m.push({pts:c,dts:c,data:n}),h+=n.length):h++;this.remuxer.remux(a,{samples:[]},{samples:m,inputTimeScale:9e4},{samples:[]},s,r,i)}destroy(){}},MP3Demuxer:class{constructor(t,e,s){this.observer=t,this.config=s,this.remuxer=e}resetInitSegment(t,e,s,r){this._audioTrack={container:"audio/mpeg",type:"audio",id:-1,sequenceNumber:0,isAAC:!1,samples:[],len:0,manifestCodec:e,duration:r,inputTimeScale:9e4}}resetTimeStamp(){}static probe(t){let s,r,i=z.getID3Data(t,0)||[];if(i&&void 0!==(z.getTimeStamp(i)||0))for(s=i.length,r=Math.min(t.length-1,s+100);s<r;s++)if(A.probe(t,s))return e.log("MPEG Audio sync word found !"),!0;return!1}append(t,e,s,r){let i=z.getID3Data(t,0)||[],a=z.getTimeStamp(i)||0,n=void 0!==a?90*a:9e4*e,o=i.length,l=t.length,d=0,c=0,u=this._audioTrack,h=[{pts:n,dts:n,data:i}];for(;o<l;)if(A.isHeader(t,o)){let e=A.appendFrame(u,t,o,n,d);if(!e)break;o+=e.length,c=e.sample.pts,d++}else z.isHeader(t,o)?(i=z.getID3Data(t,o),h.push({pts:c,dts:c,data:i}),o+=i.length):o++;this.remuxer.remux(u,{samples:[]},{samples:h,inputTimeScale:9e4},{samples:[]},e,s,r)}destroy(){}},MP4Remuxer:class{constructor(t,e,s,r){if(this.observer=t,this.config=e,this.typeSupported=s,this.ISGenerated=!1,null===B){const t="Android".match(/Chrome\/(\d+)/i);B=t?parseInt(t[1]):0}}destroy(){}resetTimeStamp(t){this._initPTS=this._initDTS=t}resetInitSegment(){this.ISGenerated=!1}getVideoStartPts(t){let s=!1;const r=t.reduce(((t,e)=>{const r=e.pts-t;return r<-4294967296?(s=!0,t):r>0?t:e.pts}),t[0].pts);return s&&e.debug("PTS rollover detected"),r}remux(t,r,i,a,n,o,l){if(this.ISGenerated||this.generateIS(t,r,n),this.ISGenerated){const s=t.samples.length,i=r.samples.length;let a=n,d=n;if(s&&i){const e=this.getVideoStartPts(r.samples),s=(t.samples[0].pts-e)/r.inputTimeScale;a+=Math.max(0,s),d+=Math.max(0,-s)}if(s){t.timescale||(e.warn("regenerate InitSegment as audio detected"),this.generateIS(t,r,n));let s=this.remuxAudio(t,a,o,l,d);if(i){let i;s&&(i=s.endPTS-s.startPTS),r.timescale||(e.warn("regenerate InitSegment as video detected"),this.generateIS(t,r,n)),this.remuxVideo(r,d,o,i)}}else if(i){let e=this.remuxVideo(r,d,o,0);e&&t.codec&&this.remuxEmptyAudio(t,a,o,e)}}i.samples.length&&this.remuxID3(i,n),a.samples.length&&this.remuxText(a,n),this.observer.trigger(s.FRAG_PARSED)}generateIS(t,a,n){let o,l,d=this.observer,c=t.samples,u=a.samples,h=this.typeSupported,m="audio/mp4",f={},p={tracks:f},g=void 0===this._initPTS;if(g&&(o=l=1/0),t.config&&c.length&&(t.timescale=t.samplerate,e.log(`audio sampling rate : ${t.samplerate}`),t.isAAC||(h.mpeg?(m="audio/mpeg",t.codec=""):h.mp3&&(t.codec="mp3")),f.audio={container:m,codec:t.codec,initSegment:!t.isAAC&&h.mpeg?new Uint8Array:C.initSegment([t]),metadata:{channelCount:t.channelCount}},g&&(o=l=c[0].pts-Math.round(t.inputTimeScale*n))),a.sps&&a.pps&&u.length){const t=a.inputTimeScale;if(a.timescale=t,f.video={container:"video/mp4",codec:a.codec,initSegment:C.initSegment([a]),metadata:{width:a.width,height:a.height}},g){const e=this.getVideoStartPts(u),r=Math.round(t*n);l=Math.min(l,u[0].dts-r),o=Math.min(o,e-r),this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o})}}else g&&f.audio&&this.observer.trigger(s.INIT_PTS_FOUND,{initPTS:o});Object.keys(f).length?(d.trigger(s.FRAG_PARSING_INIT_SEGMENT,p),this.ISGenerated=!0,g&&(this._initPTS=o,this._initDTS=l)):d.trigger(s.ERROR,{type:r.MEDIA_ERROR,details:i.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})}remuxVideo(t,a,o,l){const d=t.timescale,c=t.samples,u=[],h=c.length,m=this._initPTS;let f,p,g,y,v,b=8,S=Number.POSITIVE_INFINITY,A=Number.NEGATIVE_INFINITY,T=0,w=!1,_=this.nextAvcDts;if(0===h)return;if(!o){_=a*d-(c[0].pts-F(c[0].dts,c[0].pts))}for(let t=0;t<h;t++){const e=c[t];e.pts=F(e.pts-m,_),e.dts=F(e.dts-m,_),e.dts>e.pts&&(T=Math.max(Math.min(T,e.pts-e.dts),-1*P)),e.dts<c[t>0?t-1:t].dts&&(w=!0)}w&&c.sort((function(t,e){const s=t.dts-e.dts,r=t.pts-e.pts;return s||r||t.id-e.id})),y=c[0].dts,v=c[h-1].dts;const E=Math.round((v-y)/(h-1));if(T<0){if(T<-2*E){e.warn(`PTS < DTS detected in video samples, offsetting DTS to PTS ${n(-E,!0)} ms`);for(let t=0;t<h;t++)c[t].dts=c[t].pts-E}else{e.warn(`PTS < DTS detected in video samples, shifting DTS by ${n(T,!0)} ms to overcome this issue`);for(let t=0;t<h;t++)c[t].dts=c[t].dts+T}y=c[0].dts,v=c[h-1].dts}if(o){const t=y-_,s=t>E,r=t<-1;if(s||r){e.warn(s?`AVC: ${n(t,!0)} ms (${t}dts) hole between fragments detected, filling it`:`AVC: ${n(-t,!0)} ms (${t}dts) overlapping between fragments detected`),y=_;const r=c[0].pts-t;c[0].dts=y,c[0].pts=r,e.log(`Video: First PTS/DTS adjusted: ${n(r,!0)}/${n(y,!0)}, delta: ${n(t,!0)} ms`)}}B&&B<75&&(y=Math.max(0,y));let x=0,k=0;for(let t=0;t<h;t++){const e=c[t],s=e.units,r=s.length;let i=0;for(let t=0;t<r;t++)i+=s[t].data.length;k+=i,x+=r,e.length=i,e.dts=Math.max(e.dts,y),e.pts=Math.max(e.pts,e.dts,0),S=Math.min(e.pts,S),A=Math.max(e.pts,A)}v=c[h-1].dts;let D=k+4*x+8;try{p=new Uint8Array(D)}catch(t){return void this.observer.trigger(s.ERROR,{type:r.MUX_ERROR,details:i.REMUX_ALLOC_ERROR,fatal:!1,bytes:D,reason:`fail allocating video mdat ${D}`})}let L=new DataView(p.buffer);L.setUint32(0,D),p.set(C.types.mdat,4);for(let t=0;t<h;t++){const s=c[t],r=s.units;let i,a=0;for(let t=0,e=r.length;t<e;t++){const e=r[t],s=e.data,i=e.data.byteLength;L.setUint32(b,i),b+=4,p.set(s,b),b+=i,a+=4+i}if(t<h-1)f=c[t+1].dts-s.dts;else{const r=this.config,i=s.dts-c[t>0?t-1:t].dts;if(r.stretchShortVideoTrack){const t=r.maxBufferHole,a=Math.floor(t*d),o=(l?S+l*d:this.nextAudioPts)-s.pts;o>a?(f=o-i,f<0&&(f=i),e.log(`It is approximately ${n(o,!1)} ms to the next segment; using duration ${n(f,!1)} ms for the last video frame.`)):f=i}else f=i}i=Math.round(s.pts-s.dts),u.push({size:a,duration:f,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:s.key?2:1,isNonSync:s.key?0:1}})}this.nextAvcDts=v+f;const I=t.dropped;if(t.nbNalu=0,t.dropped=0,u.length&&"Android".toLowerCase().indexOf("chrome")>-1){const t=u[0].flags;t.dependsOn=2,t.isNonSync=0}t.samples=u,g=C.moof(t.sequenceNumber++,y,t),t.samples=[];const R={data1:g,data2:p,startPTS:S/d,endPTS:(A+f)/d,startDTS:y/d,endDTS:this.nextAvcDts/d,type:"video",hasAudio:!1,hasVideo:!0,nb:u.length,dropped:I};return this.observer.trigger(s.FRAG_PARSING_DATA,R),R}remuxAudio(t,a,o,l,d){const c=t.inputTimeScale,u=t.timescale,h=c/u,m=(t.isAAC?1024:1152)*h,f=this._initPTS,p=!t.isAAC&&this.typeSupported.mpeg;let g,y,v,b,S,A,T=p?0:8,w=t.samples,_=[],E=this.nextAudioPts;if(o|=w.length&&E&&(l&&Math.abs(a-E/c)<.1||Math.abs(w[0].pts-E-f)<20*m),w.forEach((function(t){t.pts=t.dts=F(t.pts-f,a*c)})),w=w.filter((t=>t.pts>=0)),0===w.length)return;if(o||(E=0===d?0:l?Math.max(0,a*c):w[0].pts),t.isAAC){const s=this.config.maxAudioFramesDrift;for(let r=0,i=E;r<w.length;){const a=w[r];let l=a.pts,d=l-i;if(d<=-s*m)o||r>0?(e.warn(`Dropping 1 audio frame @ ${n(i,!0)/1e3}s due to ${n(d,!0)} ms overlap.`),w.splice(r,1)):(e.warn(`Audio frame @ ${n(l,!0)/1e3}s overlaps nextAudioPts by ${n(d,!0)} ms.`),i=l+m,r++);else if(d>=s*m&&d<U){const s=Math.floor(d/m);i=l-s*m,e.warn(`Injecting ${s} audio frames @ ${n(i,!0)/1e3}s due to ${n(d,!0)} ms gap.`);for(let n=0;n<s;n++){let s=Math.max(i,0);y=R.getSilentFrame(t.manifestCodec||t.codec,t.channelCount),y||(e.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),y=a.unit.subarray()),w.splice(r,0,{unit:y,pts:s,dts:s}),i+=m,r++}a.pts=a.dts=i,i+=m,r++}else Math.abs(d),a.pts=a.dts=i,i+=m,r++}}let x=w.length,k=0;for(;x--;)k+=w[x].unit.byteLength;for(let a=0,l=w.length;a<l;a++){let l=w[a],d=l.unit,c=l.pts;if(void 0!==A&&g)g.duration=Math.round((c-A)/h);else{let a=c-E,l=0;if(o&&t.isAAC&&a){if(a>0&&a<U)l=Math.round((c-E)/m),e.log(`${n(a,!0)} ms hole between AAC samples detected,filling it`),l>0&&(y=R.getSilentFrame(t.manifestCodec||t.codec,t.channelCount),y||(y=d.subarray()),k+=l*y.length);else if(a<-12){e.log(`drop overlapping AAC sample, expected/parsed/delta: ${n(E,!0)} ms / ${n(c,!0)} ms / ${n(-a,!0)} ms`),k-=d.byteLength;continue}c=E}if(S=c,!(k>0))return;k+=T;try{v=new Uint8Array(k)}catch(t){return void this.observer.trigger(s.ERROR,{type:r.MUX_ERROR,details:i.REMUX_ALLOC_ERROR,fatal:!1,bytes:k,reason:`fail allocating audio mdat ${k}`})}if(!p){new DataView(v.buffer).setUint32(0,k),v.set(C.types.mdat,4)}for(let s=0;s<l;s++)y=R.getSilentFrame(t.manifestCodec||t.codec,t.channelCount),y||(e.log("Unable to get silent frame for given audio codec; duplicating this frame instead."),y=d.subarray()),v.set(y,T),T+=y.byteLength,g={size:y.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},_.push(g)}v.set(d,T);let u=d.byteLength;T+=u,g={size:u,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},_.push(g),A=c}let D=0;if(x=_.length,x>=2&&(D=_[x-2].duration,g.duration=D),x){this.nextAudioPts=E=A+h*D,t.samples=_,b=p?new Uint8Array:C.moof(t.sequenceNumber++,S/h,t),t.samples=[];const e=S/c,r=E/c,i={data1:b,data2:v,startPTS:e,endPTS:r,startDTS:e,endDTS:r,type:"audio",hasAudio:!0,hasVideo:!1,nb:x};return this.observer.trigger(s.FRAG_PARSING_DATA,i),i}return null}remuxEmptyAudio(t,s,r,i){let a=t.inputTimeScale,n=a/(t.samplerate?t.samplerate:a),o=this.nextAudioPts,l=(void 0!==o?o:i.startDTS*a)+this._initDTS,d=i.endDTS*a+this._initDTS,c=1024*n,u=Math.ceil((d-l)/c),h=R.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(e.warn("remux empty Audio"),!h)return void e.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");let m=[];for(let t=0;t<u;t++){let e=l+t*c;m.push({unit:h,pts:e,dts:e})}t.samples=m,this.remuxAudio(t,s,r)}remuxID3(t,e){const r=t.samples.length;if(!r)return;const i=t.inputTimeScale,a=this._initPTS,n=this._initDTS;for(let s=0;s<r;s++){const r=t.samples[s];r.pts=F(r.pts-a,e*i)/i,r.dts=F(r.dts-n,e*i)/i}this.observer.trigger(s.FRAG_PARSING_METADATA,{samples:t.samples}),t.samples=[]}remuxText(t,e){const r=t.samples.length,i=t.inputTimeScale,a=this._initPTS;if(r){for(let s=0;s<r;s++){const r=t.samples[s];r.pts=F(r.pts-a,e*i)/i}t.samples.sort((function(t,e){return t.pts-e.pts})),this.observer.trigger(s.FRAG_PARSING_USERDATA,{samples:t.samples})}t.samples=[]}},PassThroughRemuxer:class{constructor(t){this.observer=t}destroy(){}resetTimeStamp(){}resetInitSegment(){}remux(t,e,r,i,a,n,o,l){let d=this.observer,c="";t&&(c+="audio"),e&&(c+="video"),d.trigger(s.FRAG_PARSING_DATA,{data1:l,startPTS:a,startDTS:a,type:c,hasAudio:!!t,hasVideo:!!e,nb:1,dropped:0}),d.trigger(s.FRAG_PARSED)}}})})(this);"use strict";const t={isom:{container:!0},ftyp:{struct:[["majorBrand","text",4],["minorVersion","int",4],["compatibleBrands",["text",4],"end"]]},moov:{container:!0},mvhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["rate","int",4],["volume","int",2],["reserved","skip",10],["matrix",["int",4],9],["preDefined","skip",24],["nextTrackID","int",4]]},mvex:{container:!0},mehd:{struct:[["version","int",1],["flags","int",3],["fragmentDuration","int",4,"or",8]]},trex:{struct:[["version","int",1],["flags","int",3],["trackID","int",4],["sampleDescriptionIndex","int",4],["sampleDuration","int",4],["sampleSize","int",4],["sampleFlags","int",4]]},trep:{struct:[["version","int",1],["flags","int",3],["trackID","int",4]]},iods:{},trak:{container:!0},tkhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["trackID","int",4],["reserved1","int",4],["duration","int",4,"or",8],["reserved2","skip",8],["layer","int",2],["alternateGroup","int",2],["volume","int",2],["reserved3","int",2],["matrix",["int",4],9],["width","int",4],["height","int",4]]},edts:{container:!0},elst:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]],"entryCount"]]},mdia:{container:!0},mdhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["languageValues","int",2],["QTQuality","int",2]]},hdlr:{struct:[["version","int",1],["flags","int",3],["preDefined","int",4],["handlerType","text",4],["reserved","skip",12],["name","text",0]]},minf:{container:!0},vmhd:{},dinf:{container:!0},dref:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["typeText","text",4],["entryVersion","int",1],["entryFlags","int",3]]},stbl:{container:!0},stsd:{},stts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleDuration","int",4]],"entryCount"]]},stss:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["syncSamples",["int",4],"entryCount"]]},stsz:{struct:[["version","int",1],["flags","int",3],["sampleSize","int",4],["sampleCount","int",4],["sampleSizes",["int",4],"sampleCount"]]},stsc:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["firstChunk","int",4],["samplesPerChunk","int",4],["sampleDescriptionIndex","int",4]],"entryCount"]]},stco:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},co64:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",8],"entryCount"]]},ctts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleOffset","int",4]],"entryCount"]]},stdp:{},sdtp:{struct:[["version","int",1],["flags","int",3],["sampleDependencies",["int",4],"end"]]},stsh:{},udta:{container:!0},mdat:{},sidx:{struct:[["version","int",1],["flags","int",3],["referenceID","int",4],["timeScale","int",4],["earliestPresentationTime","int",4,"or",8],["firstOffset","int",4,"or",8],["reserved","int",2],["referenceCount","int",2],["references",[["subsegmentSize","int",4],["subsegmentDuration","int",4],["RAPDeltaTime","int",4]],"referenceCount"]]},smhd:{struct:[["version","int",1],["flags","int",3],["balance","int",2],["reserved","int",2]]},moof:{container:!0},mfhd:{struct:[["version","int",1],["flags","int",3],["sequenceNumber","int",4]]},traf:{container:!0},tfhd:{minLength:8,struct:[["version","int",1],["flags","int",3],["trackID","int",4],["baseDataOffset","int",8,"if",1],["sampleDescriptionIndex","int",4,"if",2],["defaultSampleDuration","int",4,"if",8],["defaultSampleSize","int",4,"if",16],["defaultSampleFlags","int",4,"if",32],["emptyDuration","int",4],["iframeSwitching","int",1]]},tfma:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]]},tfdt:{struct:[["version","int",1],["flags","int",3],["baseMediaDecodeTime","int",4,"or",8]]},trun:{struct:[["version","int",1],["flags","int",3],["sampleCount","int",4],["dataOffset","int",4,"if",1],["firstSampleFlags","int",4,"if",4],["samples",[["duration","int",4,"if",256],["size","int",4,"if",512],["flags","int",4,"if",1024],["compositionTimeOffset","int",4,"if",2048]],"sampleCount"]]},mfra:{container:!0},tfra:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},mfro:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]}};class e{constructor(e,s,r){if(!e)throw new Error("usage : new Box( boxInfo , parent , offset ) or new Box( type )");if("string"==typeof e){if(this.property=t[e],!this.property)throw new Error("not supported type : "+e);this.boxInfo={type:e,container:this.property.container}}else{if(!e.type)throw new Error("Need boxInfo.type");this.boxInfo=e,this.property=t[e.type]}this.type=this.boxInfo.type,this.container=this.boxInfo.container||this.property&&this.property.container||!1,this.setData(new Uint8Array(0),0),this.offset=null!==r&&r>0?r:0,this.id=null,this.parent=s,this.children=[],this.parent&&this.parent.appendChild(this),this.wholeSize=0}setData(t,e){this.data=t,this.buffer=new s(t),e&&(this.wholeSize=e)}setDataAndSync(t,e){this.setData(t,e),this.sync(1)}size(){return this.container?"isom"===this.type?0:8:this.wholeSize||this.data&&this.data.length}sync(t){const e=this.property&&this.property.struct||this.boxInfo.struct,s=this.property&&this.property.minLength||this.boxInfo.minLength;if(!e)return 0;if(0!==t&&1!==t&&2!==t)return 0;if(0!==t){if(this.buffer.data.length<8)return 0;this.buffer.setPos(8)}return this.recursiveProc({mode:t,struct:e,minLength:s},this,0)+8}calcLength(t,e,s){const r=typeof t;if(e=e>0?e:1,"number"==r)return t;if("string"==r){if("end"==t)return Math.floor((this.size()-this.buffer.getPos())/e);{const e=t.match(/(\w+)([\-\+\*\/\d]*)/);let s=this[e[1]]||0;const r=e[2]&&e[2][0];if(r){const t=Number(e[2].substr(1));"-"===r&&(s-=t),"+"===r&&(s+=t),"*"===r&&(s*=t),"/"===r&&(s/=t)}return s}}return 0}recursiveProc(t,e,s){const{mode:r,struct:i,minLength:a}=t;let n=0;for(let t=0,o=i.length;t<o;t++){const o=i[t][0],l=i[t][1];let d=i[t][2];const c=i[t][3],u=i[t][4];if(null===c||(this.version&&this.version>0&&"or"===c&&(d=u),!this.flags||"if"!==c||0!=(this.flags&u))){if(1===r&&!this.buffer.ready())break;if(2===r&&void 0===e[o])break;if(0===r&&a&&a<=n&&void 0===e[o])break;if("int"===l)1===d?(1===r?e[o]=this.buffer.read8():2===r&&this.buffer.write8(e[o]),n+=1):2===d?(1===r?e[o]=this.buffer.read16():2===r&&this.buffer.write16(e[o]),n+=2):3===d?(1===r?e[o]=this.buffer.read24():2===r&&this.buffer.write24(e[o]),n+=3):4===d?(1===r?e[o]=this.buffer.read32():2===r&&this.buffer.write32(e[o]),n+=4):8===d&&(1===r?e[o]=this.buffer.read64():2===r&&this.buffer.write64(e[o]),n+=8);else if("skip"===l){const t=this.calcLength(d,1);1===r?(e[o]="("+t+")bytes",this.buffer.skip(t)):2===r&&this.buffer.fill(t,0),n+=t}else if("text"===l){const t=this.calcLength(d,1);t>0?(1===r?e[o]=this.buffer.readText(t):2===r&&this.buffer.writeText(e[o],t),n+=t):(1===r?e[o]=this.buffer.readTextAsNullTermination():2===r&&this.buffer.writeTextAsNullTermination(e[o]),e[o]&&(n+=e[o].length+1))}else if(l instanceof Array&&((1===r||0===r&&void 0===e[o])&&(e[o]=[]),l.length>0)){const t=l[0]instanceof Array;let i=0;if(t)for(let t=0,e=l[0].length;t<e;t++)i+=l[0][t][2];else i=l[1];const c=0===r?e[o].length:this.calcLength(d,i);for(let i=0;i<c;i++)if(t){const t=1===r?{}:e[o][i];t&&(n+=this.recursiveProc({mode:r,struct:l,minLength:a},t,s+1),1===r&&e[o].push(t))}else n+=this.recursiveProc({mode:r,struct:[[i,l[0],l[1]]],minLength:a},e[o],s+1)}0===s&&e[o]}}return n}hasChild(t){for(let e=0,s=this.children.length;e<s;e++)if(this.children[e]===t)return e;return-1}append(t){return this.appendChild(t)}appendChild(t){if(t){if(-1===this.hasChild(t)){this.children.push(t);let e=this[t.type+"s"];e||(e=[]),e.push(t),this[t.type+"s"]=e,this[t.type]=e[0]}t.parent=this}}remove(t){return this.removeChild(t)}removeChild(t){if(t){const e=this.hasChild(t);if(-1!==e){this.children.splice(e,1);const s=this[t.type+"s"];if(s){const e=s.indexOf(t);e>=0&&s.splice(e,1),s.length>0?this[t.type]=s[0]:(delete this[t.type+"s"],delete this[t.type])}else delete this[t.type]}t.parent=null}}find(t){const e=s=>{if(s.type===t)return s;for(let t=0,r=s.children.length;t<r;t++){const r=e(s.children[t]);if(r)return r}return null};return e(this)}findAll(t){const e=(s,r)=>{s.type===t&&r.push(s);for(let t=0,i=s.children.length;t<i;t++)e(s.children[t],r);return r};return e(this,[])}arrange(){const t=e=>{const s=e.sync(0)||e.size();"mdat"!==e.type&&s!==e.data.length&&e.setData(new Uint8Array(s)),e.sync(2);let r=e.offset+s;for(let s=0,i=e.children.length;s<i;s++)e.children[s].offset=r,r+=t(e.children[s]);return e.wholeSize=r-e.offset,e.buffer.setPos(0),e.buffer.write32(e.wholeSize),e.buffer.writeText(e.type,4),e.wholeSize};return t(this)}publish(t,e,s){const r=this.sync(0);r>0&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2);const i=this.size();i>0&&t&&t.writeUint8Array(this.data,0,i),s(null)}publishToFile(t,e,s){const r=this.sync(0);r>0&&r>this.data.length&&this.setData(new Uint8Array(r)),this.sync(2);this.size()>0&&t?t(this.type,((t,e)=>{e||t.write(new Blob([this.data])),s(null)})):s(null)}inspect(){return"Box : '"+this.type+"' [ "+(this.container?"container":"prop")+" ] / "+this.size()}dump(){var t="";for(var e in this)"function"!=typeof this[e]&&(t+=e+":"+this[e]+" , ");return t}static create(s,r,i){const a={};if(a.type=s,a.struct=r||t[s].struct,a.struct||i instanceof Uint8Array){const t=new e(a);if(a.struct){t.setData(new Uint8Array(0));for(let e=0,s=a.struct.length;e<s;e++){const s=a.struct[e][0],r=a.struct[e][1];t[s]=i&&i[s]||(r instanceof Array?[]:"text"===r?"":0)}}else t.setDataAndSync(i);return t}return null}static get ignore(){return{type:1,container:1,data:1,buffer:1,offset:1,id:1,parent:1,children:1,wholeSize:1,boxInfo:1,property:1}}}class s{constructor(t){this.ptr=0,this.data=t}read8(){return this.data[this.ptr++]}read16(){return this.data[this.ptr++]<<8|this.data[this.ptr++]}read24(){return this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read32(){return this.data[this.ptr++]<<24|this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read64(){return 4294967296*this.read32()+this.read32()}readText(t){let e="";for(let s=0;s<t;s++){const t=this.data[this.ptr++];e+=String.fromCharCode(t)}return e}readTextAsNullTermination(){const t=this.data.length;let e="";for(;this.ptr<t;){const t=this.data[this.ptr++];if(0===t)break;e+=String.fromCharCode(t)}return e}readUint8Array(t,e,s){for(let r=0;r<s;r++)t[e++]=this.data[this.ptr++]}write8(t){return this.data[this.ptr++]=255&t,this}write16(t){return this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write24(t){return this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write32(t){return this.data[this.ptr++]=t>>24&255,this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write64(t){return this.write32(Math.floor(t/4294967296)),this.write32(Math.floor(t%4294967296)),this}writeText(t,e){for(let s=0,r=e=e||t.length;s<r;s++)this.data[this.ptr++]=t.charCodeAt(s);return this}writeTextAsNullTermination(t){return this.writeText(t),this.data[this.ptr++]=0,this}writeUint8Array(t,e,s){if(s<512)for(let r=0;r<s;r++)this.data[this.ptr++]=t[e++];else this.data.set(t.subarray(e,e+s),this.ptr),this.ptr+=s;return this}fill(t,e){e=e||0;for(let s=0;s<t;s++)this.data[this.ptr++]=e;return this}getPos(){return this.ptr}setPos(t){return this.ptr=t,this}skip(t){return this.ptr+=t,this}ready(){return this.ptr<this.data.length}copy(t){const e=this.data.subarray(this.ptr,this.ptr+t);return this.ptr+=t,this.ptr<0?new Uint8Array(e):e}toUint8Array(){return this.data}analyze(t){let e,s,r=null,i=this.ptr;const a=t=>!!t.match(/^[a-zA-Z0-9\u00a9]{4}$/);t?(e=this.read32(),s=this.readText(4),"mdat"===s&&1===e&&(e=this.read32()<<32|this.read32())):(e=this.data.length+8,s="isom",i-=8);if(i+e<=this.data.length&&a(s)){r={size:e-(t?0:8),type:s,container:!1,children:0};let i=8;for(;i<e;){let t=this.read32();const e=this.readText(4);if("mdat"===e&&1===t&&(t=this.read32()<<32|this.read32(),this.skip(-8)),!a(e))break;if(t<8)break;this.skip(t-8),i+=t,r.children++}e===i&&(r.container=!0)}return this.ptr=i,r}}class r{constructor(t){if(t){if("undefined"!=typeof Buffer&&t instanceof Buffer)this.data=new Uint8Array(t);else if(t instanceof Uint8Array==!1)throw new Error("Usage : new MP4( Uint8Array ) or new MP4( Buffer )")}else this.data=new Uint8Array(0);this.data=t,this.rootBox=null,this.data?this.parse():this.root=new e("isom")}parse(){const t=new s(this.data),r=s=>{const i=t.analyze(s);if(i){const a=new e(i,s,t.getPos());if(this.root||(this.root=a),i.container){a.setData(t.copy(8),i.size);for(let t=0,e=i.children;t<e;t++)r(a)}else a.setDataAndSync(t.copy(i.size))}};r(null)}get root(){return this.rootBox}set root(t){this.rootBox=t}size(){if(!this.root)return 0;const t=e=>{let s,r=e.children.length,i=e.size();for(s=0;s<r;s++)i+=t(e.children[s]);return i};return t(this.root)}tree(t,s){if(!this.root)return(t||console.log)("no box found");const r="                                  ",i=(a,n)=>{let o=(a.offset+r).substr(0,10)+"| "+r.substr(0,2*n)+"+"+a.type+" / "+a.size()+(a.container?" ( total "+a.wholeSize+" ) ":"")+(a.id?" , ID:"+a.id:"");if((t||console.log)(o),s)for(const s in a)if(!("function"==typeof a[s]||a[s]instanceof e||e.ignore[s])){let i=a[s];if(a[s]instanceof Array){if(a[s][0]instanceof e)continue;i=JSON.stringify(a[s].slice(0,10)),a[s].length>10&&(i+=" ...")}o="          | "+r.substr(0,2*n)+"  > "+s+" : "+i,(t||console.log)(o)}for(let t=0,e=a.children.length;t<e;t++)i(a.children[t],n+1)};i(this.root,0)}publish(t,e){if(!this.root)throw new Error("no rootbox found");const r=this.size(),i=new s(new Uint8Array(r)),a=(e,s)=>{let n=e.children.length;e.publish(i,(e=>{t(Math.floor(100*e/r))}),(t=>{const r=t=>{t<n?a(e.children[t],(e=>{r(t+1)})):s(null)};r(0)}))};a(this.root,(t=>{e(t,i.data)}))}async publishAsync(){return new Promise(((t,e)=>{if(!this.root)return e("no rootbox found");const r=this.size(),i=new s(new Uint8Array(r)),a=(t,e)=>{let s=t.children.length;t.publish(i,null,(()=>{const r=i=>{i<s?a(t.children[i],(()=>{r(i+1)})):e()};r(0)}))};a(this.root,(()=>{t(i.data)}))}))}async clone(){const t=await this.publishAsync();return new r(t)}static get Box(){return e}}const i=async(t,i,a)=>{a?._master?._tab?.id;if(!t||0===t.length)throw new Error("buildMP4 : Video contains no media");let n=0;for(let e=0;e<t.length;e++)t[e].mimetype.includes("video")&&(n=e);2===t.length&&1===n&&(t=[t[1],t[0]],n=0);const{skipLiveKeyFrame:o,keyFrameComplement:l,modifyESDSTrackConfig:d,over4G:c,over13H:m}=i,f=[];for(let e=0,s=t.length;e<s;e++){const s=t[e];let r=0;for(let t=0,i=s.mdats.length;t<i;t++)void 0!==s.start[t]&&(f.push({track:e,num:t,order:r,start:s.start[t]}),r++)}f.sort(((t,e)=>t.start-e.start));for(const e of t)e.mdats[0]&&9===e.mdats[0].size&&(e.mdats=[]);const p=[],g=[];for(const e of t){let t;t=e.init&&e.init.data?e.init.data.length<2e4?new r(e.init.data.slice()):e.init:await e.init.clone(),p.push(t),g.push(t.root)}p.length;for(let t=0,e=g.length;t<e;t++){const e=g[t];e.moov.mvhd.version=e.moov.trak.tkhd.version=e.moov.trak.mdia.mdhd.version=0,e.moov.trak.tkhd.flags=3;const r=t+1;if(e.moov.trak.tkhd.trackID=e.moov.mvex.trex.trackID=r,e.ftyp&&(e.ftyp.majorBrand="mp42",e.ftyp.minorVersion=0,e.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"]),d){const t=e.moov.trak.mdia.minf.stbl.stsd,r=new s(t.data);r.skip(12);const i=r.read32();for(let t=0;t<i;t++){const t=r.read32();if("mp4a"===r.readText(4)){r.skip(28);const t=r.getPos(),e=r.read32();if("esds"===r.readText(4)){r.skip(5);const s=r.read8();r.skip(4);const i=r.read8();r.skip(14);const a=r.read8();if(4===a){const n=r.read8(),o=r.read8();r.skip(2);const l=[];for(let t=0,s=e-38;t<s;t++)l.push(r.read8());r.setPos(t),r.write32(e),r.skip(9),r.write8(s-2),r.skip(4),r.write8(i-2),r.skip(14),r.write8(a-2),r.write8(16+(7&n)),r.write8(248&o);for(const t of l)r.write8(t);r.write16(0)}}else r.skip(e-8)}else r.skip(t-8)}}}const y=new r,v=y.root;v.append(g[n].ftyp),v.append(new r.Box("moov")),v.moov.append(g[n].moov.mvhd);for(const t of g)v.moov.append(t.moov.trak);v.moov.mvhd.nextTrackID=p.length+1;v.moov.mvhd.creationTime=v.moov.mvhd.modificationTime=0;for(let t=0,e=p.length;t<e;t++)v.moov.traks[t].tkhd.creationTime=v.moov.traks[t].mdia.mdhd.creationTime=v.moov.traks[t].tkhd.modificationTime=v.moov.traks[t].mdia.mdhd.modificationTime=0;const b=await(async(t,s)=>{const i=[{type:"vide",length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:"soun",length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const e of i)for(const r of t)r.mdia.hdlr.handlerType===e.type&&Object.assign(e,{trackID:r.tkhd.trackID,timeScale:r.mdia.mdhd.timeScale,length:s[r.tkhd.trackID-1].moofs.length});const a=Math.max(i[0].length,i[1].length);for(let t=0;t<a;t++)for(let a=0;a<2;a++){const n=i[a],o=s[n.trackID-1]?.moofs[t];if(!o){n.moofs[t]={empty:!0,baseMediaDecodeTime:0,duration:0};continue}const l=(o instanceof r?o:o instanceof e?{root:{moof:o}}:new r(new Uint8Array(await $(o)))).root.moof.traf;let d=l.tfdt.baseMediaDecodeTime<-2147483648?0:l.tfdt.baseMediaDecodeTime;d+=(4294967295&d)<0?4294967296:0,d/=n.timeScale;let c=!1;if(t>0)if(n.moofs[t-1].empty)c=!0;else{const{baseMediaDecodeTime:e,duration:s}=n.moofs[t-1];(d<e||d>e+2*s)&&(c=!0)}let u=0,h=0;for(const t of l.truns){t.samples=t.samples||new Array(t.sampleCount||0).fill({});const e=t.samples||[];for(const t of e)u+=t.duration||l.tfhd?.defaultSampleDuration||g[a].moov?.mvex?.trex?.sampleDuration||0,33554432&t.flags&&h++}u/=n.timeScale;const m=(l.trun?.samples?.[0]?.compositionTimeOffset||0)/n.timeScale;n.moofs[t]={baseMediaDecodeTime:d,compositionTimeOffset:m,duration:u,keyFrames:h,discontig:c},d>0&&(n.hasBaseMediaDecodeTime=!0)}return i})(v.moov.traks,t),S=(t=>{const e=[[],[]];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return e;const s=[0,0],r=[0,0];t[0].elstPadding=t[1].elstPadding=0;for(let i=0,a=Math.max(t[0].length,t[1].length);i<a;i++){const a=t[0].moofs[i],n=t[1].moofs[i];if(a&&n){if(a.empty&&(a.baseMediaDecodeTime=r[0]-s[0],a.duration=0,t[0].moofs[i+1]&&!t[0].moofs[i+1].empty&&(t[0].moofs[i+1].discontig=!0)),n.empty&&(n.baseMediaDecodeTime=r[1]-s[1],n.duration=0,t[1].moofs[i+1]&&!t[1].moofs[i+1].empty&&(t[1].moofs[i+1].discontig=!0)),0===i){const r=a.baseMediaDecodeTime-n.baseMediaDecodeTime,i=r>0?0:1,o=Math.abs(r);if(o>.01){const s=t[i].moofs?.[0]?.compositionTimeOffset||0;e[i].push({segmentDuration:Math.floor(1e3*(o+s)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})}t[i].elstPadding=o,s[0]=s[1]=-Math.min(n.baseMediaDecodeTime,a.baseMediaDecodeTime)}else if(a.discontig&&n.discontig){const t=a.baseMediaDecodeTime-n.baseMediaDecodeTime-(r[0]-r[1]);t>=0?(s[0]=r[0]+t-a.baseMediaDecodeTime,s[1]=r[1]-n.baseMediaDecodeTime):(s[0]=r[0]-a.baseMediaDecodeTime,s[1]=r[1]-t-n.baseMediaDecodeTime)}else a.discontig?s[0]=r[0]-a.baseMediaDecodeTime:n.discontig&&(s[1]=r[1]-n.baseMediaDecodeTime);a.baseMediaDecodeTime+=s[0],n.baseMediaDecodeTime+=s[1],r[0]=a.baseMediaDecodeTime+a.duration,r[1]=n.baseMediaDecodeTime+n.duration}}for(let s=0;s<2;s++){const i=t[s],a=Math.floor(1e3*(r[s]-i.elstPadding))||123456789,n=i.moofs?.[0]?.compositionTimeOffset||0,o=Math.floor(n*i.timeScale)||0;e[s].push({segmentDuration:a,mediaTime:o,mediaRateInteger:1,mediaRateFraction:0})}return e})(b);let A=[{},{}];try{localStorage.nosync||(A=await(t=>{const e=[{},{}];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return e;let s=[0,0],r=!1;t[0].duration=t[1].duration=0,t[0].original_duration=t[1].original_duration=0;const i=Math.max(t[0].length,t[1].length);for(let a=0;a<i;a++){for(let r=0;r<2;r++){if(t[r].moofs[a].empty)continue;const n=0;if(a<i-2-1){const i=t[r].duration-(t[r].moofs[a].baseMediaDecodeTime-t[r].elstPadding+n);i<-.05?(s[r]++,s[r]>=2&&(e[r][a+1]=Math.floor(i*t[r].timeScale),t[r].duration-=i,s[r]=0)):s[r]=0}t[r].original_duration+=t[r].moofs[a].duration,t[r].duration+=t[r].moofs[a].duration}if(a===i-2-2){const e=t[0].original_duration-t[1].original_duration;Math.abs(e)<.1&&(r=!0)}}if(h)for(let e=0;e<2;e++)t[e].sec=t[e].duration/t[e].timeScale;return r?[{},{}]:e})(b))}catch(t){}if(h){let t=0;t=0;for(const e in A[0])t+=A[0][e];t=0;for(const e in A[1])t+=A[1][e]}let T=0;for(const s of v.moov.traks){const i=s.mdia.minf.stbl,a=s.tkhd.trackID,n=s.mdia.hdlr.handlerType;"soun"===n&&(s.tkhd.alternateGroup=1,s.tkhd.volume=256);let{stsz:o,stts:d,stsc:h,stss:m,stco:f,ctts:p,sdtp:y,co64:v}=i;o||i.append(o=r.Box.create("stsz")),d||i.append(d=r.Box.create("stts")),h||i.append(h=r.Box.create("stsc")),m||i.append(m=r.Box.create("stss")),y||(y=r.Box.create("sdtp")),p||(p=r.Box.create("ctts")),c?(v||i.append(v=r.Box.create("co64")),f&&(i.remove(f),f=null)):(f||i.append(f=r.Box.create("stco")),v&&(i.remove(v),v=null)),o.sampleSizes=[],d.entries=[],h.entries=[],m.syncSamples=[],y.sampleDependencies=[],p.entries=[];let b=0,w=0,_=0,E=0,x=0,k=-1,D=0,L=0;const I=[];let R=0;for(const s of t[a-1].moofs){if(!s)continue;const i=s instanceof r?s:s instanceof e?{root:{moof:s}}:new r(new Uint8Array(await $(s))),c=i.root.moof;i.root.mdat&&t[a-1].mdats.push(new Blob([i.root.mdat.data]));const f=c.traf,v=f.tfhd,S=g[a-1].moov.mvex&&g[a-1].moov.mvex.trex;w++;let T=0,M=0;L+=A[a-1][w]||0;for(const t of f.truns){t.samples=t.samples||new Array(t.sampleCount||0).fill({});for(const e of t.samples){const s=Object.assign({},e);if(b++,s.duration=s.duration||v&&v.defaultSampleDuration||S&&S.sampleDuration||0,s.size=s.size||v&&v.defaultSampleSize||S&&S.sampleSize||0,s.flags=s.flags||v&&v.defaultSampleFlags||S&&S.sampleFlags||0,L=Math.floor(L),0!==L)if("vide"===n){const t=L>0?Math.min(s.duration-1,L):L;s.duration-=t,L-=t}else"soun"===n&&L<0&&s.duration<-L&&(T++,x++,R+=s.duration,o.sampleSizes.push(0),L+=s.duration);l&&0===M&&I.push(b),M++,(33554432&s.flags)>0&&("soun"===n||m.syncSamples.push(b)),o.sampleSizes.push(s.size),E!==s.duration&&(x>0&&(d.entries.push({sampleCount:x,sampleDuration:E}),x=0),E=s.duration),x++,R+=s.duration,(2048&t.flags)>0&&(k!==s.compositionTimeOffset&&D>0&&(p.entries.push({sampleCount:D,sampleOffset:k}),D=0),k=s.compositionTimeOffset,D++)}T+=t.sampleCount,f.sdtp&&y.sampleDependencies.push(...f.sdtp.sampleDependencies)}_!==T&&(_=T,h.entries.push({firstChunk:w,samplesPerChunk:_,sampleDescriptionIndex:1})),w%100==0&&await u(1)}d.entries.push({sampleCount:x,sampleDuration:E}),-1!==k&&p.entries.push({sampleCount:D,sampleOffset:k});const M=()=>{const t=[];let e=0;for(const t of o.sampleSizes)e+=t;const s=e/o.sampleSizes.length;e=0;for(const t of o.sampleSizes){const r=t-s;e+=r*r}const r=Math.sqrt(e/o.sampleSizes.length);for(let e=0,i=o.sampleSizes.length;e<i;e++){(o.sampleSizes[e]-s)/r>3&&t.push(e+1)}return t};if("vide"===n&&m.syncSamples.length<1+Math.floor(.8*w)){const t=M();t.length>m.syncSamples.length?m.syncSamples=t:l&&I.length>m.syncSamples.length&&(m.syncSamples=I),0===m.syncSamples.length&&(m.syncSamples=[1])}o.sampleCount=o.sampleSizes.length,d.entryCount=d.entries.length,h.entryCount=h.entries.length,m.entryCount=m.syncSamples.length,c?(v.entryCount=w,v.chunkOffsets=new Array(w)):(f.entryCount=w,f.chunkOffsets=new Array(w)),p.entries.length&&(p.entryCount=p.entries.length,"soun"!==n&&i.append(p)),s.mdia.mdhd.duration=R,s.tkhd.duration=Math.floor(R/s.mdia.mdhd.timeScale*1e3),s.edts||s.append(new r.Box("edts")),s.edts.elst||s.edts.append(r.Box.create("elst"));const C=p.entryCount>0?p.entries[0].sampleOffset:0,U=S[a-1]||[];U.length>0?(s.edts.elst.entryCount=U.length,s.edts.elst.entries=U):(s.edts.elst.entryCount=1,s.edts.elst.entries=[{segmentDuration:s.tkhd.duration,mediaTime:C,mediaRateInteger:1,mediaRateFraction:0}]),y.sampleDependencies.length&&i.append(y),s.mdia.mdhd.duration=R,T=Math.max(R/s.mdia.mdhd.timeScale,T)}const w=Math.floor(1e3*T);v.moov.mvhd.timeScale=1e3,v.moov.mvhd.duration=w,v.arrange();let _=y.size();for(const e of f)c?v.moov.traks[e.track].mdia.minf.stbl.co64.chunkOffsets[e.order]=_+8:v.moov.traks[e.track].mdia.minf.stbl.stco.chunkOffsets[e.order]=_+8,_+=t[e.track].mdats[e.num].size;const E=[new Blob([await y.publishAsync()])];for(const e of f)E.push(t[e.track].mdats[e.num]);return new Blob(E,{type:"appplication/octet-stream"})},a=(t,e)=>{try{const s=t.root.moov.trak.tkhd,r=e.root.moov.trak.tkhd,i=((t,e)=>{const s=t.length;if(s!==e.length)return!1;for(let r=0;r<s;r++)if(t[r]!==e[r])return!1;return!0})(s.matrix,r.matrix)&&s.width===r.width&&s.height===r.height,a=t.root.moov.trak.mdia.mdhd,n=e.root.moov.trak.mdia.mdhd,o=a.timeScale===n.timeScale&&a.languageValues===n.languageValues,l=t.root.moov.trak.mdia.hdlr,d=e.root.moov.trak.mdia.hdlr,c=l.handlerType===d.handlerType&&l.name===d.name;return i&&o&&c}catch(t){return!0}},n=["B","KB","MB","GB","TB"],o=(t,e)=>{const s=[];return JSON.stringify(t,((t,r)=>{if(e.includes(t))return"#discard";if("_"===t[0])return"#discard";if("object"==typeof r&&null!==r){const t=s.indexOf(r);if(t>=0&&s[t]===r)return"#discard";s.push(r)}return r}))},l=()=>{const t=new Date,e=t=>(""+t).padStart(2,"0");return" "+t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+"_"+e(t.getMinutes())},d=t=>(t.match(/https?:\/\/([^\/]+)/)||[])[1],c=t=>{if(!t)return null;let e={};for(const s in t)e["LM_"+s]=t[s]||"null";return e},u=t=>new Promise(((e,s)=>{setTimeout(e,t)})),h=localStorage.log,m="verbose"===localStorage.log,f=navigator.userAgent.includes("Chrome")?chrome:browser,p=(f.runtime.getManifest(),f.i18n),g=navigator.userAgent.includes("Edge"),y=(!g&&navigator.userAgent.includes("Firefox"),!g&&navigator.userAgent.includes("Chrome")&&Number((navigator.userAgent.match(/Chrome\/(\d+)/)||[])[1]||0),1),v=4,b=2,S=4,A=-1,T=1,w=2,_="High_Resolution",E="Low_Resolution",x="Other_Resolutions",k={content:"#48c774",border:"#1a8431"},D={content:"#ffc107",border:"#ef2020"},L="speed",I=1,R=2,M=3,C=4,U=t=>{localStorage.option=JSON.stringify(t)},P=(()=>{const t=localStorage.option;let e={counter:0,priority:L,domain:{}};try{t&&Object.assign(e,JSON.parse(t)),e.counter=Math.max(0,Math.floor(Number(e.counter)||0)),localStorage.option=JSON.stringify(e)}catch(t){}return e})(),O=localStorage.ilog,B={rcounterr:0,recltime:30};f.runtime.sendMessage({eventName:"GET_BG_OPTIONS"},(t=>{try{t&&Object.assign(B,t)}catch(t){}}));const F=t=>{const e=t.root;if(e.moov){const t=e.moov.traks.length;if(t>1&&e.moov.mvex.trexs.length===t){const s=[];for(let i=0;i<t;i++){const t=new r,a=t.root;e.ftyp&&a.append(e.ftyp),a.append(new r.Box("moov")),a.moov.append(e.moov.mvhd),a.moov.append(new r.Box("mvex")),a.moov.mvex.append(e.moov.mvex.trexs[i]),a.moov.append(e.moov.traks[i]),a.arrange(),s.push(t)}return s}}else if(e.moof){const s=t.data,i=e.moof.trafs.length;if(i>1){const t=[];for(let a=0;a<i;a++){const i=new r,n=i.root;e.styp&&n.append(e.styp),e.sidx&&n.append(e.sidx),n.append(new r.Box("moof")),n.moof.append(e.moof.mfhd),n.moof.append(e.moof.trafs[a]),n.arrange(),n.publish(null,null,(()=>{})),t.push(i);const o=[];let l=0;for(const t of e.moof.trafs[a].truns){let r=e.moof.offset+t.dataOffset,i=0;for(const e of t.samples)i+=e.size;o.push(s.slice(r,r+i)),l+=i}const d=new Uint8Array(8);l+=8,d.set([l>>24&255,l>>16&255,l>>8&255,255&l,109,100,97,116]),i.mdat=new Blob([d,...o]),i.isDivided=!0}return t}}return[t]},N=t=>{const e=t?.init?.root?.moov?.trak?.mdia;if(e){const t=e.mdhd?.timeScale;if(t)return t;if(e.hdlr){if("vide"===e.hdlr.handlerType)return 9e4;if("soun"===e.hdlr.handlerType)return 48e3}}return 1e3},z=(t,e,s)=>{if(!t||!e)return{moofDuration:0,moofStart:0};s=s||0;const r=e&&e.moofs&&e.moofs[s],i=e&&e.sidx;if(i){const{timeScale:e,earliestPresentationTime:a}=i;let n;Math.abs(r.traf.tfdt.baseMediaDecodeTime/t.root.moov.trak.mdia.mdhd.timeScale-a/e),a&&e?n=a/e:r.traf.tfdt.baseMediaDecodeTime&&t.root.moov.trak.mdia.mdhd.timeScale&&(n=r.traf.tfdt.baseMediaDecodeTime/t.root.moov.trak.mdia.mdhd.timeScale);const o=i.references&&i.references[s]&&i.references[s].subsegmentDuration;if(e&&void 0!==n&&o){return{moofDuration:o/e,moofStart:n}}}if(r&&t&&t.root&&t.root.moov){const e=t.root.moov.trak.mdia.mdhd.timeScale,s=r.traf;if(s&&e){const{tfhd:r,trun:i,tfdt:a}=s;if(r&&a&&i){const n=a.baseMediaDecodeTime/e,o=r.defaultSampleDuration;if(i.samples){let r=0;for(const t of s.truns)for(const e of t.samples)r+=e.duration||o||0;if(0===r){const e=t.root.moov.mvex&&t.root.moov.mvex.trex&&t.root.moov.mvex.trex.sampleDuration||0;for(const t of s.truns)r+=(t.sampleCount||0)*e}return r/=e,{moofDuration:r,moofStart:n}}}}}return{moofDuration:0,moofStart:0}},G=t=>{if(t&&t.start){const e=t.start.length;if(e>1)for(let s=t.contig;s<e-1;s++){const e=t.start[s],r=t.duration[s],i=t.start[s+1];if(Math.abs(e+r-i)>.1)return!0;t.contig=s+1}}return!1},q=t=>{let e=0;for(const s of t)s.init&&s.moofs.length>0&&e++;return t.length===e},H=t=>{for(const e of t){const t=e.start.length-1;if(t>=2){const{moofs:s,mdats:r,start:i,durations:a}=e;if(s.length===r.length&&s.length===i.length&&s.length===a.length&&i[t-2]<i[t]&&i[t]<i[t-1]){const e=i[t-2]+a[t-2];if(Math.abs(e-i[t])<Math.abs(e-i[t-1])){(e=>{for(const s of e){const e=s[t-1];s[t-1]=s[t],s[t]=e}})([s,r,i,a])}}}}},V=t=>{for(const e of t)if(e.init&&e.moofs.length>1){const t=e.moofs.length-1;e.start[t]===e.start[t-1]&&e.durations[t]===e.durations[t-1]&&(e.moofs.splice(t-1,1),e.mdats.splice(t-1,1),e.start.splice(t-1,1),e.durations.splice(t-1,1))}if(2!==t.length)return;if(t[0].start.length<1||t[1].start.length<1)return;const e=t[0],s=t[1];let r=null,i=Math.abs(e.start[0]-s.start[0]);if(e.start.length>1){const t=Math.abs(e.start[1]-s.start[0]);t<i&&(i=t,r=e)}if(s.start.length>1){const t=Math.abs(s.start[1]-e.start[0]);t<i&&(i=t,r=s)}r&&(r.moofs.splice(0,1),r.mdats.splice(0,1),r.start.splice(0,1),r.durations.splice(0,1))},$=async t=>new Promise(((e,s)=>{const r=new FileReader;r.onload=t=>{e(r.result)},r.onerror=t=>{s(r.error)},r.readAsArrayBuffer(t)})),j=t=>new Promise(((e,s)=>{const r=new XMLHttpRequest;r.onreadystatechange=()=>{4===r.readyState&&200===r.status&&e(r.response)},r.open("GET",t),r.responseType="blob",r.send()})),K="main";class X{constructor(){this.url=null,this.headers=null,this.master=null,this.details=null,this.retry=0}async load(t,e){return this.url=t,this.headers=e,this.retry=0,await this.loadPlayList()}get isMaster(){return this.master}get isLevelDetail(){return this.details}async loadPlayList(t){const{url:e,headers:s}=this;try{const r=await rt({url:e,method:"GET",headers:t||s});if(!r.ok){if(this.retry++,this.retry>=2)return{status:r.status,message:"retry "+this.retry+" times"};if(await u(1e3),t||403!==r.status)return await this.loadPlayList();{const t=Object.assign({},s);return t.Referer=t.Origin=null,await this.loadPlayList(t)}}const i=await r.text();if(i.indexOf("#EXTINF:")>0||i.indexOf("#EXT-X-TARGETDURATION:")>0)this.details=await this._handleTrackOrLevelPlaylist(i,e,0);else{const t=await this._handleMasterPlaylist(i,e,null,null,null);this.master=this.onManifestLoaded(t)}t&&(this.headers=t)}catch(t){return{status:900,message:t.message||t||"unkown"}}return{status:300,message:"ok"}}async _handleMasterPlaylist(t,e,s,r,i){const a=t,{levels:n}=M3U8Parser.parseMasterPlaylist(a,e);n?.length;const o=M3U8Parser.parseMasterPlaylistMedia(a,e,"SUBTITLES");let l=M3U8Parser.parseMasterPlaylistMedia(a,e,"AUDIO",n.map((t=>({id:t.attrs.AUDIO,codec:t.audioCodec}))));if(l.length){let t=!1;l.forEach((e=>{e.url||(t=!0)})),!1===t&&n[0].audioCodec&&!n[0].attrs.AUDIO&&l.unshift({type:"main",name:"main"})}return{levels:n,audioTracks:l,subtitles:o}}async _handleTrackOrLevelPlaylist(t,e,s){const r=K,i=M3U8Parser.parseLevelPlaylist(t,e,s,r);if(!i.targetduration)throw Error("[Abort] invalid target duration"+t.status);return i}onManifestLoaded(t){let e,s=[],r={},i=null,a=!1,n=!1,o=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),l=[];const d=t.subtitles,c=d&&d.length>0;if(t.levels.forEach((t=>{t.loadError=0,t.fragmentError=!1,a=a||!!t.videoCodec,n=n||!!t.audioCodec||!(!t.attrs||!t.attrs.AUDIO),!0===o&&t.audioCodec&&-1!==t.audioCodec.indexOf("mp4a.40.34")&&(t.audioCodec=void 0),i=r[t.bitrate],void 0===i?(t.url=[t.url],t.urlId=0,r[t.bitrate]=t,s.push(t)):i.url.push(t.url)})),!0===a&&!0===n&&(s=s.filter((({videoCodec:t})=>!!t))),s=s.filter((({audioCodec:t,videoCodec:e})=>(!t||isCodecSupportedInMp4(t))&&(!e||isCodecSupportedInMp4(e)))),t.audioTracks&&(l=t.audioTracks.filter((t=>!t.audioCodec||isCodecSupportedInMp4(t.audioCodec,"audio")))),s.length>0){e=s[0].bitrate,s.sort(((t,e)=>t.bitrate-e.bitrate));for(let t=0;t<s.length&&s[t].bitrate!==e;t++);return{levels:s,audioTracks:l,audio:n,video:a,altAudio:l.length>0,subtitles:d,subtitle:c}}throw Error("no level with compatible codecs found in manifest")}}const Y={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')},W=[{demux:TSDemuxer,remux:MP4Remuxer},{demux:MP4Demuxer,remux:PassThroughRemuxer},{demux:AACDemuxer,remux:MP4Remuxer},{demux:MP3Demuxer,remux:MP4Remuxer}],Q={stretchShortVideoTrack:!1,maxBufferHole:.5,maxAudioFramesDrift:1,enableSoftwareAES:!0,forceKeyFrameOnDiscontinuity:!0};class J{constructor(t,e,s,r){this.demuxer=null,this.remuxer=null,this.initSegment=t,this.audioCodec=e,this.videoCodec=s,this.duration=r,this.result={},this.resolve=null,this.reject=null,this._evt_=[]}init(){this.demuxer&&(this.demuxer.resetInitSegment(this.initSegment,this.audioCodec,this.videoCodec,this.duration),this.demuxer.resetTimeStamp()),this.remuxer&&(this.remuxer.resetInitSegment(),this.remuxer.resetTimeStamp())}get observer(){return{trigger:(t,e)=>{if(this._evt_.push(t.replace(/hlsFrag/,"").replace(/hls/,"")),"hlsError"===t&&this.reject({fatal:!1,message:e}),t===HlsEvents.FRAG_PARSED)return this._evt_=[],this.resolve(this.result);t===HlsEvents.FRAG_PARSING_INIT_SEGMENT?this.result[t]=e:t===HlsEvents.FRAG_PARSING_DATA&&(this.result[t]||(this.result[t]=[]),this.result[t].push(e))}}}demux(t,e,s,r,i){return new Promise((async(e,a)=>{this.result={},this.resolve=e,this.reject=a;try{if(t=new Uint8Array(t),!this.demuxer){for(const e of W)if(e.demux.probe(t)){this.remuxer=new e.remux(this.observer,Q,Y,navigator.vendor),this.demuxer=new e.demux(this.observer,this.remuxer,Q,Y);break}if(!this.demuxer)return a({fatal:!0,message:"suitable demuxer not found"});i=!1}i||this.init(),this.demuxer.append(t,s,i,r)}catch(t){a({fatal:!0,message:t.message})}}))}}const Z={url:{}},tt=async(t,e=!1)=>{const s=t.isLive&&t.hasAltAudio?(t=>{let e=0;for(const s of t){const t=s.start.length;t>0&&s.start[t-1]>e&&(e=s.start[t-1])}let s=e;for(const e of t)e.start.length>0&&e.start[0]<s&&(s=e.start[0]);const r=[];for(const e of t){const{mimetype:t,init:s}=e;r.push({mimetype:t,init:s,moofs:[],mdats:[],start:[]})}for(let i=s;i<=e;i++){const e=[];for(let s=0,r=t.length;s<r;s++){const r=t[s].start.indexOf(i);-1!==r&&e.push(r)}if(e.length===t.length)for(let s=0,i=t.length;s<i;s++){const i=t[s],a=e[s],n=r[s];n.moofs.push(i.moofs[a]),n.mdats.push(i.mdats[a]),n.start.push(i.start[a])}}return r})(t.tracks):(t=>{const e=[];for(const s of t)if(s.init&&s.moofs.length>0){const t=s.moofs.slice(0),r=s.mdats.slice(0),i=s.start.slice(0),{mimetype:a,init:n}=s;e.push({mimetype:a,init:n,moofs:t,mdats:r,start:i})}return e})(t.tracks),{size:r,sourceType:a}=t;if(0===s.length||0===s[0].moofs.length)return null;const n={skipLiveKeyFrame:a===S,keyFrameComplement:a===S,modifyESDSTrackConfig:a===S,over4G:r>4e9,over13H:!1};try{const r=await i(s,n);if(e)return r;const a=URL.createObjectURL(r);return Z.url[a]=1,t._master.saveSettings(),a}catch(t){return null}},et=t=>(t.startsWith("//")&&(t=location.protocol+t),t);let st=[];const rt=t=>{let{url:e,method:s,headers:r,resultType:i,timeout:a}=t;return t.headers=c(t.headers||{}),new Promise(((s,r)=>{e=et(e),t.revokeList=st,st=[],f.runtime.sendMessage({cmd:"fetch",params:t},(t=>{const{ok:e,blobUrl:i,message:a}=t;e?fetch(i).then((t=>{t.ok?(st.push(i),s(t)):r({status:-1,message:"failed to fetch"})})).catch((t=>{r({status:-1,error:t})})):r({status:-1,message:a})})),a&&setTimeout((()=>{r({status:408})}),a)}))},it=async(t,e)=>{t?._master?._tab?.id;const s=e?t._master.audioTracks[t._master.selected_audioLevel||0]:t._master.levels[t._master.selected_level];if(e&&(t.hasAltAudio=s?.details?.fragments?.length>0,!t.hasAltAudio))return;const r=e?"_audio":"",i=s.details,a=i.fragments,n=1e3*Math.max((i.averagetargetduration||i.totalduration/i.fragments)-.1,.5);let o=1,l=!1;const d=()=>{l=!1};t["destroyFunc"+r]=d;const c=new X,h=i.url,m=(t,e)=>{d(),e&&(o=e)},f=e=>{t._master._tab.sendMessage("message",{vId:t.vId,on:"error",message:e})};let g=0;l=!0,(async()=>{for(;l;){try{const e=await c.load(h,i.requestHeaders);if(300!==e.status)return m(e.status,1);{const e=c.details&&c.details.fragments||[];if(!(e.length>0))return m(0,1);{let r=a[a.length-1];for(const n of e)if(n.sn>r.sn){if(n.sn-r.sn>1){const e=p.getMessage("warn_discontig_fragments_found");t._master._tab.sendMessage("message",{vId:t.vId,on:"warn",message:'<span style="color:#f88;font-size:x-small">'+e+"</span>"})}a.push(n),n._n=r._n+1,n._parent=i,n.demuxer=s.details.demuxer,r=n,g=0}else if(n.cc!==r.cc){const e=p.getMessage("warn_chapter_has_changed");t._master._tab.sendMessage("message",{vId:t.vId,on:"warn",message:'<span style="color:#f88;font-size:x-small">'+e+"</span>"})}if(g++,g>=30)return m(0,1)}}}catch(t){m(0,2),f("[ FATAL ] Faild to load index, "+(t.message||t))}await u(n)}})();let y=0;for(;l;){const s=a[y];if(s){const r=y<a.length-1?1:3,{data:i,error:n}=await pt(s,r);if(n){if(y<a.length-1){y++;continue}m(0,2),f("Failed to fetch TS, abort, status : "+(n.status||"Maybe this website uses HLS-encryption and does not want to be downloaded."));break}try{await s.demuxer.demux({video:t,fragment:s,data:i})}catch(t){m(0,2),f("[ FATAL ] Faild to demux : "+t.message);break}if(y++,!e&&(t.createPreviewOnce(),t.updateProgress(),5===y))for(let e=0,s=t.tracks.length;e<s;e++){if(!t.tracks[e].init){const s=t.index.audio===e?"TErrorNoAudio":"TErrorNoVideo";t._master._tab.sendMessage("message",{vId:t.vId,on:"warn",message:p.getMessage(s)+p.getMessage("TerrTryToRec")})}}}else await u(n)}m(),1===o&&(await t.flush(),t.complete()),e||t._master._tab.sendMessage("message",{on:"title",message:p.getMessage("Tdone")})},at=(t,e,s)=>{let i=s.tracks;i.audiovideo&&(i=(t=>{const e=new r(t.initSegment).root;if(!e.moov)return t;const{container:s,codec:i}=t,a={};for(let t=0,n=e.moov.traks.length;t<n;t++){const n=new r,o=n.root;e.ftyp&&o.append(e.ftyp),o.append(new r.Box("moov")),o.moov.append(e.moov.mvhd),o.moov.append(new r.Box("mvex")),o.moov.mvex.append(e.moov.mvex.trexs[t]),o.moov.append(e.moov.traks[t]),o.arrange(),a["vide"===e.moov.traks[t].mdia.hdlr.handlerType?"video":"audio"]={initSegment:n,container:s,codec:i,isMP4:!0}}return a})(i.audiovideo));for(const e in i){if(!e.match(/audio|video/))continue;const s=i[e],a=t.getTrackByType(e);if(s.initSegment){const t=s.isMP4?s.initSegment:new r(s.initSegment),e=t.root&&t.root.moov;t.id=e?`${s.container}:${s.codec}:${e.trak.tkhd.width}:${e.trak.tkhd.height}:${e.trak.mdia.mdhd.timeScale}`:`${s.container}:${s.codec}:void`,a.init=t}try{if("video"===e){const t=a.init.root.moov.trak.tkhd;a.quality=Math.floor(t.width/65536+.4)+" x "+Math.floor(t.height/65536+.4)}else{const t=a.init.root.moov.trak.mdia.mdhd;a.quality=t.timeScale+" Hz"}}catch(t){a.quality=""}}t.updateQualityLabel()},nt=t=>{const e=t=>{"mdat"!==t.type&&(t.data=null,t.buffer=null);for(let s=0,r=t.children.length;s<r;s++)e(t.children[s])};return e(t)},ot=(t,e,s)=>{const{type:i,startPTS:a,endPTS:n,startDTS:o,endDTS:l,hasAudio:d,hasVideo:c,dropped:u,nb:h,data1:m,data2:f}=s;let p=0;if(!i.match(/audio|video/))return;if("audiovideo"===i)return((t,e,s)=>{const{type:i,startPTS:a,endPTS:n,startDTS:o,endDTS:l,hasAudio:d,hasVideo:c,dropped:u,nb:h,data1:m,data2:f}=s,p=new r(new Uint8Array(m)),g=F(p);if(1===g.length){const s=g[0];for(let r=0;r<s.root.moofs.length;r++){const i=s.root.moofs[r],a=t.getTrackByNumber(i.traf.tfhd.trackID),n=a.moofs.length;a.moofs[n]=i,a.mdats[n]=new Blob([s.root.mdats[r].data]),a.start[n]=1e9*e.cc+n}for(let s=0;s<t.tracks.length;s++)t.tracks[s].duration+=e.duration}else{const s=e._n;for(const r of g){const i=t.getTrackByNumber(r.root.moof.traf.tfhd.trackID);i.moofs[s]=r.root.moof,i.mdats[s]=r.mdat,i.start[s]=1e9*e.cc+e.sn,i.duration+=e.duration}}t.size+=m?.byteLength||0})(t,e,s);const g=t.getTrackByType(i);let y=g.init;const v=e._n;if(y&&y.id.includes("void")&&f&&MpegAudio.isHeader(f,0)){const t=MpegAudio.parseHeader(f,0);y=g.init=(t=>{const{sampleRate:e,channelCount:s}=t,i=new r,a=i.root;a.append(new r.Box("moov"));const n=r.Box.create("mvhd",null,{timeScale:e,duration:0,rate:65536,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824],preDefined:24,nextTrackID:0});a.moov.append(n),a.moov.append(new r.Box("trak"));const o=a.moov.trak,l=r.Box.create("tkhd",null,{flags:3,trackID:1,duration:0,layer:0,alternateGroup:1,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824]});o.append(l),o.append(new r.Box("mdia"));const d=r.Box.create("mdhd",null,{timeScale:e,duration:5120,languageValues:21956});o.mdia.append(d);const c=r.Box.create("hdlr",null,{handlerType:"soun",name:"SoundHandler"});o.mdia.append(c),o.mdia.append(new r.Box("minf")),o.mdia.minf.append(r.Box.create("smhd")),o.mdia.minf.append(new r.Box("dinf")),o.mdia.minf.dinf.append(r.Box.create("dref",null,{entryCount:1,entrySize:12,typeText:"url ",entryVersion:0,entryFlags:1})),o.mdia.minf.append(new r.Box("stbl"));const u=r.Box.create("stsd",[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["code","text",4],["reserved","int",3],["reserved2","int",3],["dataReferenceIndex","int",2],["reserved3","int",8],["channelCount","int",2],["sampleSize","int",2],["reserved4","int",4],["sampleRate","int",2],["reserved5","int",2]],{entryCount:1,entrySize:36,code:".mp3",dataReferenceIndex:1,channelCount:s,sampleSize:16,sampleRate:e});return o.mdia.minf.stbl.append(u),a.moov.append(new r.Box("mvex")),a.moov.mvex.append(r.Box.create("trex",null,{sampleDescriptionIndex:1,sampleFlags:65537})),i.id=`audio/mp3:${a.moov.trak.mdia.mdhd.timeScale}`,a.arrange(),i})(t)}if(m&&!f){const t=new r(new Uint8Array(m));for(let s=0;s<t.root.moofs.length;s++){const r=g.moofs.length,i=t.root.moofs[s],a=i.offset,n=a+i.wholeSize;P.priority===L?(nt(i),g.moofs[r]=i):g.moofs[r]=new Blob([m.slice(a,n)]),g.mdats[r]=new Blob([t.root.mdats[s].data]),g.start[r]=1e9*e.cc+e.sn,p+=n-a+g.mdats[r].size}}else if(y&&y.id.includes("mp3")){if(!f)return;const{moof:t,mdat:s}=(t=>{const e=[],s=t.length;for(let r=0;r<s;){const s=MpegAudio.parseHeader(t,r);if(!s)break;const i=s.frameLength;e.push({duration:s.samplesPerFrame,size:i}),r+=i}const i=new r;i.root.append(new r.Box("moof")),i.root.moof.append(new r.Box("traf")),i.root.moof.traf.append(r.Box.create("tfhd",[["version","int",1],["flags","int",3],["trackID","int",4],["defaultSampleFlags","int",4,"if",32]],{flags:32,defaultSampleFlags:65536})),i.root.moof.traf.append(r.Box.create("tfdt",null,{}));const a=r.Box.create("trun",null,{flags:768,sampleCount:e.length,samples:e});i.root.moof.traf.append(a),i.root.arrange();const n=new Uint8Array(8),o=s+8;return n.set([o>>24&255,o>>16&255,o>>8&255,255&o,109,100,97,116]),{moof:i,mdat:new Blob([n,t])}})(f);g.moofs[v]=t,g.mdats[v]=s,g.start[v]=1e9*e.cc+e.sn,p=f.byteLength}else{if(!m||!f)return;if(P.priority===L){const t=new r(new Uint8Array(m));nt(t.rootBox),g.moofs[v]=t}else g.moofs[v]=new Blob([m]);g.mdats[v]=new Blob([f]),g.start[v]=1e9*e.cc+e.sn,p=m.byteLength+f.byteLength}g.duration+=e.duration,t.size+=p};class lt{constructor(t){this.demuxer=new J(t.details.initSegment.data||[],t.audioCodec,t.videoCodec,t.details.totalduration),this.prevSN=-1,this.prevCC=-1,this.prevError=null}async demux(t){const{video:e,fragment:s,data:r}=t,i=isNaN(s.startDTS)?s.start:s.startDTS;try{const t=s.sn===this.prevSN+1&&s.cc===this.prevCC&&!this.prevError;this.prevError=null,this.prevSN=s.sn,this.prevCC=s.cc;const a=await this.demuxer.demux(r,s.decryptdata,i,!0,t),n=a[HlsEvents.FRAG_PARSING_INIT_SEGMENT];n&&at(e,0,n);const o=a[HlsEvents.FRAG_PARSING_DATA];if(o)for(const t of o)ot(e,s,t)}catch(t){if(m&&t.stack,t.fatal)throw t;this.prevError=t}}}function dt(t){const e=localStorage.getItem(t);if(!e)return null;const s=JSON.parse(e);return(new Date).getTime()>s.expiry?(localStorage.removeItem(t),null):s.value}const ct=t=>{const e=e=>{return(s=t,s.split("").map((t=>t.charCodeAt(0)))).reduce(((t,e)=>t^e),e);var s};return t=>t.match(/.{1,2}/g).map((t=>parseInt(t,16))).map(e).map((t=>String.fromCharCode(t))).join("")};function ut(t,e=!1){try{const s=document.getElementById("trySpeedo"),r=document.getElementById("triedSpeedo"),i=document.getElementById("tringSpeedo");switch(t.tried){case"0":r.style.display="none",s.style.display="inline";break;case"1":s.style.display="none"}e&&(r.style.display="inline"),"1"==t.okTotry?i.style.display="inline":i.style.display="none"}catch(t){}}function ht(){function t(t){const e=JSON.stringify(t),s=60*(1440-60*(new Date).getHours()-(new Date).getMinutes())*1e3;!function(t,e,s){const r={value:e,expiry:(new Date).getTime()+s};localStorage.setItem(t,JSON.stringify(r))}("speedo",(t=>{const e=t=>t.split("").map((t=>t.charCodeAt(0))),s=t=>("0"+Number(t).toString(16)).substr(-2),r=s=>e(t).reduce(((t,e)=>t^e),s);return t=>t.split("").map(e).map(r).map(s).join("")})("mySecretSalt2021")(e),s)}let e=dt("speedo");if(e){e=ct("mySecretSalt2021")(e),e=JSON.parse(e)}else e={okTotry:"0",tried:"0"},t(e);ut(e);const s=document.getElementById("trySpeedo");if(s){function e(){const e={okTotry:"0",tried:"1"};t(e),ut(e,showTried=!0)}s.onclick=function(){let s=dt("speedo");if(s){s=ct("mySecretSalt2021")(s);try{if(s=JSON.parse(s),"0"==s.tried){const s={okTotry:"1",tried:"1"};t(s),ut(s),setTimeout(e,6e4)}}catch(t){}}}}}function mt(t){for(var e=document.getElementsByClassName("html5-progress-bar"),s=0;s<e.length;++s){var r=e[s];"add"==t?r.classList.add("html5-progress-bar-slow"):r.classList.remove("html5-progress-bar-slow")}}function ft(){if(Math.random()<.3)return;const t=document.getElementById("dlSpeedNotice");t&&(t.style.display="block")}const pt=async(t,e,s)=>{if(e=Math.max(1,Math.min(5,e||1)),t.decryptdata&&null!=t.decryptdata.uri&&null==t.decryptdata.key)return{error:new Error("HLS-encryption is not supported : abort"),data:null};const r=t._byteRange?{Range:"bytes="+t._byteRange[0]+"-"+(t._byteRange[1]-1)}:{},i=t._parent?.requestHeaders||{},a=[Object.assign({...r},i),Object.assign(Object.assign({...r},i),{Referer:null,Origin:null})];let n=null;for(let r=0;r<e;r++){const e=a[r%a.length];try{if(B.counter>50){if(new URL(document.location.href).pathname.indexOf("hls.vhtml")<0){let t=!1,e=dt("speedo");if(e){e=ct("mySecretSalt2021")(e);try{e=JSON.parse(e),"1"==e.okTotry&&(t=!0)}catch(t){}}if(t)mt("remove");else{mt("add"),B.waittime||(B.waittime=1e3),B.waittime<1e3&&(B.waittime=1e3);const t=Math.floor(Math.random()*(1e4-B.waittime+1))+B.waittime;await u(t),setTimeout(ft,6e4)}}}const i=await rt({url:t.url,method:"GET",headers:e,resultType:"arrayBuffer",timeout:s});if(i.ok){const s=await i.arrayBuffer();return t.loaded=s.byteLength,t.autoLevel=!1,r>0&&(t._parent.requestHeaders=e),{error:null,data:s}}}catch(t){if(408===t.status)return{error:t,data:null};n=t}await u(1e3)}return{error:n,data:null}},gt=async t=>{if(t){const e=t.details;if(e){if(e.initSegment){const{data:t,error:s}=await pt(e.initSegment);e.initSegment.data=s?null:new Uint8Array(t)}else e.initSegment={data:null};const s=new lt(t);e.demuxer=s;let r=0,i=-1;for(const t of e.fragments)i!==t.cc&&(i=t.cc,r=0),t._parent=e,t.demuxer=s,t._n=r,r++}}},yt=async(t,e={})=>{const{levels:s,audioTracks:r,subtitles:i,settings:a,selected_audioLevel:n}=t;let{level:o,quality:l,audioLevel:d}=e;const c=l||a.quality;o=c===E?0:c===_?s.length-1:o,null==o&&(o=a.level),o=Math.max(0,Math.min(s.length-1,o));const u=s[o];if(void 0===d){const e=r.filter((t=>t.groupId===u.attrs.AUDIO)),s=e.find((t=>t.default))||e[0],i=r[n],a=e.includes(i)?i:s;d=t.audioTracks.indexOf(a)}d=Math.max(0,Math.min(r.length-1,d));const h=r[d];if(void 0!==e.level&&(t.settings.level=o,t.settings.quality=l,t.saveSettings(),t.selected_level===o&&t.selected_audioLevel===d))return{status:w};if(await gt(u),await gt(h),!u?.details)return{status:A,message:"Failed to init the level of quality, abort."};t.setLevel(o,d),t.video?.destroy();for(const e of t.archives)e.destroy();return t.archives=[],t.updateUI("level initialized"),u.details.live?new bt(t,!0).start().catch((t=>{})):new bt(t).start().catch((t=>{})),{status:T}};class vt{constructor(t,e,s){this._master=t,this.settings=Object.assign({},t.settings),this.vId=Math.floor(1e8*Math.random()),this.sourceType=s,this.tracks=[],this.index={},this.size=0,this.isPreviewed=!1,this.isLive=e,this.hasAltAudio=!1,this._master.video=this,this.mId=t.mId,this.stat=I,this.blobURL=null,this.dateLabel=l()}async load(){this.stat=R,this._master._tab.sendMessage("update_ui",{vId:this.vId,action:R})}async pause(t){this.stat=I,this._master._tab.sendMessage("update_ui",{vId:this.vId,action:I,message:t})}complete(){this.stat=M,this._master.archives.push(this)}destroy(){this.blobURL&&(URL.revokeObjectURL(this.blobURL),delete Z.url[this.blobURL],this.blobURL=null),this.stat=C,this._master.video===this&&(this._master.video=null),this._master._tab.sendMessage("update_ui",{vId:this.vId,action:C})}updateQualityLabel(){let t="",e="";for(const s of this.tracks)s?.mimetype?.includes("video")&&(t=s.quality),s?.mimetype?.includes("audio")&&(e=s.quality);this.quality=t+(""!==t?" - ":"")+e}async updateUI(t){await this._master._tab.sendMessage("update_video",{signature:t,video:o(this,["demuxer","data","fragments","moofs","mdats","rootBox","parent"])})}async updateProgress(t){const e=this.tracks[0]?.duration;await this._master._tab.sendMessage("video_progress",{vId:this.vId,size:this.size,duration:e,quality:this.quality,progress:t})}async flush(){if(this.stat!==C){const t=await tt(this);if(t)return this.blobURL&&(URL.revokeObjectURL(this.blobURL),delete Z.url[this.blobURL]),this.blobURL=t,await this._master._tab.sendMessage("flushed",{vId:this.vId,p:"flush"}),!0}return!1}async createPreviewOnce(t){if(!this.isPreviewed){t=t||0;for(const e of this.tracks)if(e.init&&e.mimetype.includes("video")&&e.moofs.length>t&&e.mdats.length>t){this.isPreviewed=!0;const t=await tt(this);t?(await this._master._tab.sendMessage("flushed",{vId:this.vId,url:t,p:"preview"}),URL.revokeObjectURL(t),delete Z.url[t]):this.isPreviewed=!1;break}}}getTrackByType(t){return void 0===this.index[t]&&(this.index[t]=this.tracks.length,this.tracks.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,mimetype:t,quality:""})),this.tracks[this.index[t]]}getTrackByNumber(t){for(const e of this.tracks)if(e.init?.root?.moov?.trak?.tkhd?.trackID===t)return e;return null}clearAllTracks(){for(const t of this.tracks)this.clearTrack(t)}clearTrack(t){t.moofs=[],t.mdats=[],t.start=[],t.durations=[],t.duration=0}get qualityLabel(){let t="",e="";for(const s of this.tracks)s.init&&(s.mimetype.includes("video")&&(t=s.quality),s.mimetype.includes("audio")&&(e=s.quality));return t+(""!==t?" - ":"")+e}assign(t){for(const e in t)this[e]=t[e]}}class bt extends vt{constructor(t,e,s){super(t,e,b),this.isLive=e,this.contig=!1,this.parallel_max=1,s&&this.inherit(s),this.updateUI("new_hlsvideo")}inherit(t){const{tracks:e,index:s,isLive:r}=t,i=[];for(const t of e){const{mimetype:e,init:s}=t;i.push({mimetype:e,init:s,moofs:[],mdats:[],start:[],durations:[]})}this.tracks=i,this.index=s,this.isLive=r}async start(){super.load(),this.isLive?(it(this,!0),await it(this)):await(async t=>{t._master._tab.id;const e=t._master.levels[t._master.selected_level],s=t._master.audioTracks[t._master.selected_audioLevel||0];t.hasAltAudio=s?.details?.fragments?.length>0;const r=(t=>{const e=1e5;return t.sort(((t,s)=>t.cc*e+t.start-(s.cc*e+s.start))),t})([...e.details.fragments,...t.hasAltAudio?s.details.fragments:[]]),i={};let a=0,n=r[0].cc;for(let t=0,e=r.length;t<e;t++){const e=r[t];n!==e.cc&&(i[n]=a,n=e.cc,a=0),a++}i[n]=a;const o=t.contig||0;n=r[o].cc;const l=(location.href.match(/start=(\d+)/)||[])[1],d=(location.href.match(/stop=(\d+)/)||[])[1],c=0===o&&l&&!t.hasAltAudio?Math.max(0,Number(l)):o,u=0===o&&d&&!t.hasAltAudio?Math.min(r.length,Number(d)):r.length,m={max:Math.min(u-c,i[n]),current:0,offset:c},f=((new Date).getTime(),{}),g={},y={},v=(t,e)=>{t[e=e||0]&&(t[e](),delete t[e])},b=(t,e)=>new Promise(((s,r)=>{v(t,e=e||0),t[e]=s}));let S=c,A=u;for((async()=>{let e=0,s=c,i=u;try{for(;s<i&&s<r.length;){for(;e<t.parallel_max&&s<S+30&&(await t.wait(),!(s>=i||s>=r.length));){const i=r[s];if(i.__fragment_index__=s,n!==i.cc){const r=new bt(t._master,!1,t);return r.contig=s,await r.start(),e=S=99999,v(f,i.__fragment_index__)}(async r=>{const i=r.__fragment_index__;e++;const{data:a,error:n}=await pt(r,3);e--,v(f,i),v(y),n?(t.pause("Faild to fetch TS, "+(n.status||n.message)),s=i,await t.wait()):r._data=a})(i),s++}e>=t.parallel_max&&await b(y),s>=S+30&&await b(g)}}catch(t){}})();S<A;){const e=r[S];if(e._data){try{await e.demuxer.demux({video:t,fragment:e,data:e._data})}catch(e){t.pause("[ FATAL ] Faild to demux : "+e.message);break}delete e._data,v(g),S++,m.current++,t.createPreviewOnce(),t.updateProgress(m)}else await b(f,S)}h&&(new Date).getTime();await t.flush(),t.complete(),t._master._tab.sendMessage("message",{on:"title",message:p.getMessage("Tdone")+" - "+u+" / "+u})})(this)}async wait(){return new Promise(((t,e)=>this.stat===R?t():this.stat===C?e({message:"receive VIDEO_STATUS.DESTORY"}):void(this.pauseResolver=t)))}async destroy(){super.destroy(),this.destroyFunc&&this.destroyFunc(),this.destroyFunc_audio&&this.destroyFunc_audio(),this.destroyFunc=this.destroyFunc_audio=null}}class St extends vt{constructor(t,e,s){if(super(t,!0,S),s){const{tracks:t,index:e}=s;this.assign({tracks:t,index:e})}this.mediasourceid=e,this.updateUI("new_capturedvideo")}}const At=class{constructor(t,e,s,r,i,a=null){this._tab=t,this.mId=a||Math.floor(1e8*Math.random()),this.url=e,this.levels=s instanceof Array?s:s?[s]:[],this.audioTracks=r instanceof Array?r:r?[r]:[],this.subtitles=i instanceof Array?i:i?[i]:[],this.video=null,this.archives=[],this.settings=Object.assign({},t.settings),this.selected_level=this.settings.level,this.selected_audioLevel=null}async updateUI(t){await this._tab.sendMessage("update_master",{master:o(this,["demuxer","data","fragments","moofs","mdats","rootBox","parent"]),signature:t})}setLevel(t,e){this.selected_level=t,this.selected_audioLevel=e}getLevel(){}saveSettings(){const t=d(this._tab.url),e=P.domain[t],s=this.settings.quality,r=this.settings.level,i=this._tab.mode;e&&e.quality===s&&e.level===r&&e.mode===i||(P.domain[t]={quality:s,level:r,mode:i},U(P))}},Tt=class{constructor(t){this.id=t.id,this.parentTabId=t.parentTabId,this.url=t.url||"",this.title=t.title||"no-title",this.mode=y,this.foundMasterIndex=!1,this.mastersList=[],this.origin=(this.url.match(/https?:\/\/[^\/]+/)||[])[0]||"noOrigin";const e=d(this.url),s=P.domain[e]||{};this.settings=Object.assign({level:0,quality:_,mode:y},s)}get isLoader(){return this.parentTabId}async consume(t){const e=await(async(t,e)=>{let s=[];const r=e=>{for(const s of t.mastersList)if(s.url===e)return!0;return!1};for(const i of e){if(i.processed)continue;i.processed=!0;const e=i.referer,a=(e.match(/https?:\/\/[^\/]+/)||[])[0]||"",n=i.header||{Referer:e,Origin:a},o=i.header?{Referer:e,Origin:a}:{};let l;const d=URLToolkit.buildAbsoluteURL(e,i.url,{alwaysNormalize:!0});if(!r(d))try{const r=new X;let i=await r.load(d,n);if(l=n,300!==i.status&&(i=await r.load(d,o),l=o),300===i.status)if(r.isMaster){t.foundMasterIndex||(s=[],t.foundMasterIndex=!0);const a=r.master,{levels:c,audioTracks:u,subtitles:h}=a;s.push(new At(t,d,c,u,h));for(const t of[...c,...u]){if(!t.url)continue;const s="string"==typeof t.url?t.url:t.url[0],r=URLToolkit.buildAbsoluteURL(e,s,{alwaysNormalize:!0}),a=new X;i=await a.load(r,n),l=n,300!==i.status&&(i=await a.load(r,o),l=o),300===i.status&&a.isLevelDetail&&(t.details=a.details,t.details.requestHeaders=l)}}else if(r.isLevelDetail&&!t.foundMasterIndex){const e={attrs:{},audioCodec:null,videoCodec:null,width:0,height:0,bitrate:0,details:r.details,url:d};e.details.requestHeaders=l,s.push(new At(t,d,e))}}catch(t){}}return s})(this,t);e.forEach((t=>yt(t))),this.mastersList.push(...e)}sendMessage(t,e){zt({cmd:t,params:e})}findMaster(t){return this.mastersList.find((e=>e.mId===t))}findVideo(t){for(const e of this.mastersList){if(e.video?.vId===t)return{master:e,video:e.video};for(const s of e.archives)if(s.vId===t)return{master:e,video:s}}return{master:null,video:null}}};Object.assign(Tt,{TAB_ID:0,PARENT_ID:1,CHILD_ID:2}),f.runtime.onMessage.addListener(((t,e,s)=>{const{cmd:i,params:n}=t;if("udpate_index"===i){const{type:t,que:e}=n;Ct.consume(e)}else"intercept_ondata"===i&&(async(t,e)=>{const{url:s,mimetype:i,mediasourceid:n,bufferid:o,timestamp:l}=e;if("disconnect"===s){for(const e of t.mastersList){const t=e.video;t&&(await t.flush(),t.complete())}return void t.sendMessage("message",{on:"title",message:p.getMessage("Tdone")})}if(0===t.mastersList.length&&f.runtime.sendMessage({cmd:"intercept_ok",params:{}}),i.includes("webm"))return;let d=t.findMaster(n);d||(d=new At(t,t.url,null,null,null,n),t.mastersList.push(d));let c=d.video;if(c||(c=new St(d,n)),new URL(document.location.href).pathname.indexOf("hls.vhtml")<0&&B.rcounterr>30&&(B.recltime>100&&(B.recltime=100),Math.trunc(Pt[c.vId].duration/60)>=B.recltime))return c.stat!=M&&(c.flush(),c.complete()),Pt[c.vId].maxRecTimeLimit.style.display="block",void(document.title="! Maximum recording time limit has been reached");let{tracks:u,index:h}=c;if("abort"===s)return await c.flush(),c.complete(),void c._master._tab.sendMessage("message",{on:"title",message:p.getMessage("Tdone")});const m=await j(s),g=await $(m),y=new r(new Uint8Array(g));let v=0;const b=F(y);for(const e of b){const s=o+(1===b.length?"":b.indexOf(e));c=d.video;const r=e.root.moovs,l=e.root.moofs,m=e.root.mdats||e.mdat;void 0===h[s]&&(h[s]=u.length,u.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,contig:0,mimetype:i,quality:""}));const f=u[h[s]],y=t=>{t=t||0;const{moofDuration:s,moofStart:r}=z(f.init,e.root,t),i=e.root.moofs[t],a=r+Math.min(1e4,i.mfhd?.sequenceNumber||0)/1e8;return f._prev={sequenceNumber:a,moofStart:r,moofDuration:s},{moof:i,sequenceNumber:a,moofStart:r,moofDuration:s}};if(O){const t=i.includes("video")||i.includes("avc1"),s=i.includes("audio")||i.includes("mp4a"),{moofDuration:a,moofStart:n}=z(f.init,e.root),o=(f.init&&f.init.root.moov.trak.tkhd.width,[]);s&&o.push("audio"),t&&o.push("video");const d=[];r&&d.push("initSegment"),l&&d.push("Moof"),m&&d.push("Mdat"),l&&e.root.moofs.map((t=>t.mfhd.sequenceNumber)).join(",")}if(r){f.init&&q(u)&&!a(f.init,e)&&(await c.flush(),c.complete(),c.clearTrack(f),c=new St(d,n,c)),f.init=e;const t=f.init.root.moov.trak;t&&(t.tkhd.width?(f.quality=Math.floor(t.tkhd.width/65536+.4)+" x "+Math.floor(t.tkhd.height/65536+.4),f.mimetype="video"):(f.quality=t.mdia.mdhd.timeScale+" Hz",f.mimetype="audio")),c.updateQualityLabel()}if(l){if(e.root.moofs[0]&&e.root.moofs[0].traf&&e.root.moofs[0].traf.senc)return void t.sendMessage("message",{vId:c.vId,on:"error",message:p.getMessage("TerrDrmFound")});if(N(f),e.isDivided){const{moof:t,sequenceNumber:s,moofStart:r,moofDuration:i}=y();f.moofs.push(e),f.start.push(s),f.durations.push(i),f.duration+=i}else for(let t=0,s=e.root.moofs.length;t<s;t++){const{moof:e,sequenceNumber:s,moofStart:r,moofDuration:i}=y(t),a=e.offset,n=a+e.wholeSize;-1===f.start.indexOf(s)&&(P.priority===L?f.moofs.push(e):f.moofs.push(new Blob([g.slice(a,n)])),f.start.push(s),f.durations.push(i),f.duration+=i)}if(0===h[s]&&f.moofs.length>=5e3&&f.moofs.length%1e3==0){const t=p.getMessage("warn_chunksize_excess").replace("NUM_CHUNKS",f.moofs.length);c._master._tab.sendMessage("message",{vId:c.vId,on:"warn",message:'<span style="color:#f88;font-size:x-small">'+t+"</span>"})}}if(m)if(e.isDivided)f.mdats.push(e.mdat),v+=e.mdat.size;else if(l&&e.root.moofs.length===e.root.mdats.length)for(let t=0,s=e.root.mdats.length;t<s;t++){const{moof:s,sequenceNumber:r,moofStart:i,moofDuration:a}=y(t),n=f.start.indexOf(r);-1===n||f.mdats[n]||(f.mdats[n]=new Blob([e.root.mdats[t].data]),v+=e.root.mdats[t].data.byteLength)}else for(const t of e.root.mdats)f.mdats.push(new Blob([t.data])),v+=t.data.byteLength;V(u),H(u),G(f)&&await c.flush()&&(c.complete(),c.clearAllTracks(),c=new St(d,n,c))}c&&(c.size+=v,c.updateProgress(),c.createPreviewOnce(1))})(Ct,n);s({result:!0})}));const wt=async t=>{const{cmd:e,params:s}=t,r=Ct;if("select_option"===e){const{mId:t}=s,e=r.findMaster(t);if(e){return await yt(e,s)}return{status:A,message:"Internal error at CMD_SELECT_OPTION. Please tell the message to the developer."}}if("resume"!==e)if("pause"!==e)if("cancel"!==e)if("save"!==e)if("download_subtitle"!==e)if("set_parallel"!==e)if("return_video_file"!=e);else{const{vId:t}=s,{master:e,video:i}=r.findVideo(t),a=await tt(i,pureVideoFile=!0),n=await new Response(a).arrayBuffer();window.postMessage({type:"webResVideoFile",videoFile:n},location.href,[n])}else{const{vId:t,parallel_max:e}=s,{master:i,video:a}=r.findVideo(t);a&&(a.parallel_max=Math.min(6,Math.max(1,e)))}else{const{subtitle:t,mId:e,vId:i}=s,a=r.findMaster(e);if(a){const e=await(async(t,e,s)=>{const r=t.subtitles?.[e];if(r){const e=new X;if(300===(await e.load(r.url)).status){const i=[],a=e.details.fragments,n=a.length;for(let e=0;e<n;e++){const r=a[e],o=await rt({url:r.url,method:"GET"});if(!o.ok)return!1;{const r=await o.text();i.push(r),i.push("\n\n"),await t._tab.sendMessage("subtitle_progress",{vId:s,current:e,total:n})}}const o=new Blob(i,{type:"text/vtt"});if(o){const e=URL.createObjectURL(o);if(e){const s=document.createElement("a");return s.href=e,s.download=(t?._tab?.title||"no_title")+"_"+r.lang+"_"+r.name+".vtt",s.click(),!0}}}}return!1})(a,t,i);return e}}else{const{master:t,video:e}=r.findVideo(s.vId);if(e){const t=t=>{const s=document.createElement("a");s.href=t,s.download=(e?._master?._tab?.title||"no-title")+(e.isLive?e.dateLabel:"")+".mp4",s.click()};if(e.blobURL)t(e.blobURL);else{const s=await tt(e);t(s),URL.revokeObjectURL(s),delete Z.url[s]}}}else{const{vId:t}=s,{master:e,video:i}=r.findVideo(t);i&&i.destroy()}else{const{vId:t}=s,{master:e,video:i}=r.findVideo(t);i&&i.pause()}else{const{vId:t}=s,{master:e,video:i}=r.findVideo(t);i&&(i.pauseResolver&&(i.pauseResolver(),i.pauseResolver=null),i.load())}};class _t{constructor(t,e){const s=document.getElementById("loadingNotice");s&&(s.style.display="none");const{vId:r,settings:i}=t;this.vId=r,this.settings=i;const a=document.createElement("div"),n=document.getElementById("oneDownVideo").innerHTML;a.innerHTML=n;document.getElementById("videos").appendChild(a),this.container=a,this.loading=!0,this.size=0,this.duration=0;const o=async()=>{this.saveButton.classList.contains("disabled")||(this.saveButton.classList.add("disabled"),this.saveButton.classList.add("loading"),this.loading&&e&&await e(),await wt({cmd:"save",params:{vId:r}}),await u(1e3),this.saveButton.classList.remove("disabled"),this.saveButton.classList.remove("loading"))};this.save2GdriveButton&&this.save2GdriveButton.addEventListener("click",(function(){wt({cmd:"return_video_file",params:{vId:r}})})),this.saveButton.addEventListener("click",o),this.forceRenderLink.addEventListener("click",o);this.closeButton.addEventListener("click",(async()=>{await wt({cmd:"cancel",params:{vId:r}})})),this.errorLabel.innerHTML="&nbsp;";const d=this.video;d._mouseEvents={enter:()=>{d.src&&(d.controls=!0)},leave:()=>{d.src&&(d.controls=!1)}},d.addEventListener("mouseover",d._mouseEvents.enter),d.addEventListener("mouseout",d._mouseEvents.leave),this.dateLabel=l(),this.titleLabel.innerText=Ct.title,this.titleLink.title=Ct.title,this.titleLink.href=Ct.url,this.doneInit={};var c={};if(localStorage.getItem("cococutDlSettings")&&(c=JSON.parse(localStorage.getItem("cococutDlSettings"))),this.setAutoSaveDiv){this.setAutoSaveDiv.querySelector("#setAutoSave").checked=c.setAutoSave}if(this.setSpeedUpRecDiv){const t=this.setSpeedUpRecDiv.querySelector("#setSpeedUpRec");t.checked=c.setSpeedUpRec;const e=function(){const e={tabId:Ct.parentTabId,checked:t.checked};f.runtime.sendMessage({eventName:"SET_SPEEDUP_REC",data:e})};t.checked&&e(),t.addEventListener("click",(function(){e()}))}}start(){}pause(){}update(){}update_subtitleProgress(){}get video(){return this.container.querySelector("video")}get progress(){return this.container.querySelector(".progress")}get loadCtrls(){return this.container.querySelectorAll(".dlVprocessBtns")}get downloadLink(){return this.container.querySelector("#dlVfinalFile")}get stopButton(){return this.container.querySelector("#dlVstopBtn")}get startButton(){return this.container.querySelector("#dlVstartBtn")}get saveButton(){return this.container.querySelector("#dlVsaveBtn")}get save2GdriveButton(){return this.container.querySelector("#save2GDrive")}get closeButton(){return this.container.querySelector(".dlVignoreThis")}get forceRenderLink(){return this.container.querySelector("#dlVforceSaveBtn")}get titleLabel(){return this.container.querySelector("#dlStatusS")}get titleLink(){return this.container.querySelector("#dlStatusA")}get sizeLabel(){return this.container.querySelector("#dlVsize")}get durationLabel(){return this.container.querySelector("#dlVtime")}get progressLabel(){return this.container.querySelector("#dlVsegments")}get qualityLabel(){return this.container.querySelector("#dlVResolution")}get subtitleSelectLabel(){return this.container.querySelector("#subtitleSel")}get subtitleProgress(){return this.container.querySelector(".subtitleProgress")}get audioSelectLabel(){return this.container.querySelector("#audioSel")}get qualitySelectLabel(){return this.container.querySelector("#dlVResolutionSel")}get boostLabel(){return this.container.querySelector("#dlVaccelerate")}get errorLabel(){return this.container.querySelector("#dlVerr")}get statusLabel(){return this.container.querySelector("#dlType")}get recordCached(){return this.container.querySelector("#recordCached")}get downloadProgress(){return this.container.querySelector("#downloadProgress")}get bufferedLabel(){return this.container.querySelector("#bufferedLabel")}get setAutoSaveDiv(){return this.container.querySelector("#setAutoSaveDiv")}get setSpeedUpRecDiv(){return this.container.querySelector("#setSpeedUpRecDiv")}get maxRecTimeLimit(){return this.container.querySelector("#maxRecTimeLimit")}addSize(t){this.setSize(this.size+t)}setSize(t){this.size=t;const e=(t=>{if(t<1)return{value:0,unitIdx:0};const e=Math.floor(Math.log(t)/Math.log(1024)),s=Math.floor(10*t/Math.pow(1024,e))/10;return s<1e3?{value:s,unitIdx:e}:{value:Math.floor(s),unitIdx:e}})(this.size);this.sizeLabel.innerText=e.value+" "+n[e.unitIdx]}addDuration(t){this.setDuration(this.duration+t)}setDuration(t){this.duration=t,this.durationLabel.innerText=this.getDurationString()}getDurationString(){return String(Math.trunc(this.duration/60))+":"+String(Math.trunc(this.duration%60)).padStart(2,"0")}setQuality(t){this.qualityLabel.innerHTML=t}setWarn(t){this.errorLabel.innerHTML=t,this.errorLabel.style.display="inline"}setError(t){this.errorLabel.innerHTML=t,this.errorLabel.style.display="inline";const e=this.errorLabel.querySelector("#errTryToRec");e&&e.addEventListener("click",(()=>{document.getElementById("confirm-switch").click()})),this.progress.style.background=D.content,this.stopButton.classList.add("disabled"),document.title.includes("!")||(document.title="! "+document.title)}setStatus(t,e){void 0!==e&&(this.statusLabel.style.background=e),void 0!==t&&(this.statusLabel.innerText=t,"HLS"==t?(this.recordCached.style.display="none",this.downloadProgress.style.display="block",this.bufferedLabel.style.display="block"):"Live"==t?(this.recordCached.style.display="none",this.downloadProgress.style.display="none",this.bufferedLabel.style.display="none"):"Recording"==t&&(this.recordCached.style.display="block",this.downloadProgress.style.display="none",this.bufferedLabel.style.display="none"))}showControl(t){this.loadCtrls.forEach((e=>{e.style.display=t?"inline":"none"}))}showSaveButton(t){this.saveButton.style.display=t?"inline":"none",this.save2GdriveButton&&(this.save2GdriveButton.style.display=t?"inline":"none")}showCloseButton(t){this.closeButton.style.display=t?"inline":"none"}terminate(){const t=k;if(this.setStatus("Finished",t.content),this.loading=!1,this.showControl(!1),this.showSaveButton(!0),this.setAutoSaveDiv){this.setAutoSaveDiv.querySelector("#setAutoSave").checked&&wt({cmd:"save",params:{vId:this.vId}})}}removeSelf(){const t=document.getElementById("videos");t&&t.contains(this.container)&&(t.removeChild(this.container),wt({cmd:"cancel",params:{vId:this.vId}}))}setMessage(t,e){"title"===t?document.title=e:"warn"===t?this.setWarn(e):"error"===t&&this.setError(e)}setQualityOptionByMaster(t){const e=(e,s)=>{e.addEventListener("click",(async()=>{try{if(this.loadingSubs)return;const e=await s(t);this.loadingSubs=!0,e.vId=this.vId,e.mId=t.mId,this.subtitleProgress.style.display="block",this.subtitleProgress.value=0,this.subtitleProgress.max=0;const r=await wt({cmd:"download_subtitle",params:e});this.subtitleProgress.style.display="none",this.loadingSubs=!1,r.status===A&&this.setError(r.message)}catch(t){}}))},s=(e,s)=>{e.addEventListener("click",(async()=>{this.stopButton.click(),this.forceRenderLink.style.display="none";try{const e={},i=await s(t);if(null!=i.level){const{quality:s,level:a,audioLevel:n}=r(i.quality,i.level,t);Object.assign(e,{quality:s,level:a,audioLevel:n})}else e.audioLevel=i.audioLevel;const a={level:t.settings.level,quality:t.settings.quality,audioLevel:t._suitable_audio_level,mId:t.mId},n=await wt({cmd:"select_option",params:Object.assign(a,e)});n.status===w?(this.startButton.click(),n.message&&this.setWarn(n.message)):n.status===A&&this.setError(n.message)}catch(t){"cancelled"===t?.message&&this.startButton.click()}}))},r=(t,e,s)=>{const{audioTracks:r,selected_audioLevel:i}=s,{level:a,levelObj:n}=((t,e,s)=>{const{levels:r,settings:i}=s;return null==(e=t===E?0:t===_?r.length-1:e)&&(e=i.level),{level:e=Math.max(0,Math.min(r.length-1,e)),levelObj:r[e]}})(t,e,s),o=r.filter((t=>t.groupId===n.attrs.AUDIO)),l=o.find((t=>t.default))||o[0],d=r[i],c=o.includes(d)?d:l;let u=r.indexOf(c);return u=Math.max(0,Math.min(r.length-1,u)),{quality:t,level:a,levelObj:n,suitableAudioTracks:o,audioLevel:u,audioObj:c}};t.levels.length>1?(this.qualitySelectLabel.innerHTML=p.getMessage("Resolution")+'&nbsp;-&nbsp;<a href="javascript:void(0)">'+p.getMessage(this.settings.quality)+"</a>",this.qualitySelectLabel.style.display="inline",s(this.qualitySelectLabel,Lt)):this.qualitySelectLabel.innerHTML=p.getMessage("Resolution")+"&nbsp;-&nbsp;( "+p.getMessage("TnoResulution")+" )";const{quality:i,level:a}=t.settings,{level:n,suitableAudioTracks:o,audioLevel:l,audioObj:d}=r(i,a,t);t._suitable_audio_tracks=o,t._suitable_audio_level=l;if(o.length>1){const t=d.lang||d.name;this.audioSelectLabel.innerHTML=p.getMessage("TAudio")+'&nbsp;-&nbsp;<a href="javascript:void(0)">'+t+"</a>",this.audioSelectLabel.style.display="inline",s(this.audioSelectLabel,It)}t.subtitles.length>0&&(this.subtitleSelectLabel.innerHTML=p.getMessage("subtitle"),this.subtitleSelectLabel.style.display="inline",e(this.subtitleSelectLabel,Rt))}}function Et(t){var e;for(e=t.options.length-1;e>=0;e--)t.remove(e)}class xt extends _t{constructor(t,e){super(t,e);const{vId:s,settings:r}=t;this.setStatus("HLS"),this.durationLabel.style.display="none",this.progressLabel.style.display="inline",this.setAutoSaveDiv&&(this.setAutoSaveDiv.style.display="inline"),this.isBoosting=!1,this.boostLabel&&this.boostLabel.addEventListener("click",(()=>{this.isBoosting=!this.isBoosting,this.boostLabel.style.setProperty("color",this.isBoosting?"#007bff":"#000");const t=Math.max(1,Math.min(6,this.isBoosting?Number(localStorage.accelerate)||3:1));wt({cmd:"set_parallel",params:{vId:s,parallel_max:t}})})),Mt("hls"),this.startButton.addEventListener("click",(async()=>{await wt({cmd:"resume",params:{vId:s}})})),this.stopButton.addEventListener("click",(async()=>{await wt({cmd:"pause",params:{vId:s}})}));const i=Ut[t.mId];i&&this.setQualityOptionByMaster(i)}start(){this.startButton.classList.add("disabled"),this.stopButton.classList.remove("disabled"),this.forceRenderLink.style.display="none",this.save2GdriveButton&&(this.save2GdriveButton.style.display="none"),this.progress.style.removeProperty("background"),this.errorLabel.innerHTML="&nbsp;",document.title=document.title.replace("! ","")}pause(t){this.startButton.classList.remove("disabled"),this.stopButton.classList.add("disabled"),this.forceRenderLink.style.display="inline",this.save2GdriveButton&&(this.save2GdriveButton.style.display="inline"),t&&this.setError(t)}update_videoProgress(t){const{size:e,duration:s,quality:r,progress:i}=t,{max:a,current:n,offset:o}=i;this.setSize(e),this.setQuality(r),this.progress.max=a,this.progress.value=n,this.progressLabel.innerText=n+" / "+a,document.title=n+o+" / "+(a+o)+" - "+p.getMessage("Tloading")}update_subtitleProgress(t){this.subtitleProgress.value=t.current+1,this.subtitleProgress.max=t.total}}class kt extends _t{constructor(t,e){super(t,e),this.setStatus("Live",D.content),this.showControl(!1),this.showSaveButton(!0),this.showCloseButton(!0),this.statusLabel.style.marginTop="8px",this.boostLabel&&(this.boostLabel.style.display="none"),Mt("live");const s=Ut[t.mId];s&&this.setQualityOptionByMaster(s)}update_videoProgress(t){const{size:e,duration:s,quality:r}=t;this.setSize(e),this.setQuality(r),this.setDuration(s||0),document.title=this.durationLabel.innerText+" - "+p.getMessage("TRecording")}}class Dt extends _t{constructor(t,e){super(t,e),this.setStatus("Recording",D.content),this.showControl(!1),this.showSaveButton(!0),this.boostLabel&&(this.boostLabel.style.display="none"),Mt("capture"),document.getElementById("recordInfo").style.display="block",this.success=!1,this.setSpeedUpRecDiv&&(this.setSpeedUpRecDiv.style.display="inline"),this.setAutoSaveDiv&&(this.setAutoSaveDiv.style.display="inline")}update_videoProgress(t){const{size:e,duration:s,quality:r}=t;this.success||(document.getElementById("recordInfo").style.display="none",this.success=!0),this.setSize(e),this.setQuality(r),this.setDuration(s),document.title=this.durationLabel.innerText+" - "+p.getMessage("TRecording")}}const Lt=t=>{const{levels:e,settings:s}=t;return new Promise(((t,r)=>{const i=document.getElementById("resChooseDialog"),a=i.querySelectorAll('input[name="resChooseRadio"]'),n=i.querySelector("select");Et(n);const o=s.quality,l=s.level;for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.attrs.BANDWIDTH,i=s.attrs.RESOLUTION,a=document.createElement("option"),o=(i?i+" , ":"")+(r?r+" bps":"");a.setAttribute("value",t),a.innerHTML=o,t===l&&(a.selected=!0),n.appendChild(a)}const d=t=>{const e=t.target.value;n.disabled=e!==x};for(const t of a)t.addEventListener("click",d);for(const t of document.querySelectorAll('input[name="resChooseRadio"]'))t.value===o&&t.click();i.querySelector(".close-modal").addEventListener("click",(()=>{r({message:"cancelled"})}));i.querySelector("#resChooseComfirmBtn").addEventListener("click",(()=>{const s=document.querySelector('input:checked[name="resChooseRadio"]');if(s){const r=s.value;t(r===_?{level:e.length-1,quality:r}:r===E?{level:0,quality:r}:{level:n.selectedIndex,quality:r})}else t({level:0,quality:E})})),document.getElementById("showResChooseDialogBtn").click(),i.classList.add("active")}))},It=t=>{const{audioTracks:e,_suitable_audio_tracks:s,_suitable_audio_level:r}=t,i=s.indexOf(e[r]);return new Promise(((t,r)=>{const a=document.getElementById("chooseMusicDialog"),n=a.querySelector(".form-group"),o=a.querySelector("#chooseMusicTemp").innerHTML;for(let t=0,e=s.length;t<e;t++){const e=s[t],{audioCodec:r,lang:a,name:l,details:d}=e,c=d.totalduration,u=t,h=`[ ${a} ]  ${l} ( ${r} )`,m="Duration : "+String(Math.trunc(c/60))+":"+String(Math.trunc(c%60)).padStart(2,"0"),f=document.createElement("div");f.innerHTML=o.replace(/\$value/,u).replace(/\$label/,h).replace(/\$tooltip/,m),t==i&&(f.querySelector("input").checked=!0),n.appendChild(f)}a.querySelector(".close-modal").addEventListener("click",(()=>{r({message:"cancelled"})}));a.querySelector("button").addEventListener("click",(()=>{const r=a.querySelector('input:checked[name="audios"]');if(r){const i=Number(r.value),a=s[i],n=e.indexOf(a);t({audioLevel:n})}else t({audioLevel:0})})),document.getElementById("showChooseMusicDialogBtn").click(),a.classList.add("active")}))},Rt=t=>{const{subtitles:e}=t;return new Promise(((t,s)=>{const r=document.getElementById("chooseSubtitleDialog"),i=r.querySelector("select");Et(i);for(let t=0,s=e.length;t<s;t++){const{lang:s,name:r}=e[t],a=document.createElement("option"),n=`[ ${s} ]  ${r}`;a.setAttribute("value",t),a.innerHTML=n,i.appendChild(a)}r.querySelector(".close-modal").addEventListener("click",(()=>{s({message:"cancelled"})}));r.querySelector("button").addEventListener("click",(()=>{t({subtitle:i.selectedIndex})})),document.getElementById("showChooseSubtitleDialogBtn").click(),r.classList.add("active")}))},Mt=t=>{document.getElementById("Notice_closeTabRec").style.display="capture"===t?"inline":"none"};let Ct=null;const Ut={},Pt={},Ot=t=>new Promise(((e,s)=>{try{t.msgSender="cocoParser",f.runtime.sendMessage(t,(t=>{f.runtime.lastError,e(t)}))}catch(t){}})),Bt=(t,e)=>{if(Ct.mode!==t||e){Ct.mode=t,Ft(),Nt();const e=document.querySelector(t===v?"#recordInfo":"#dlHlsInfo");e&&(e.style.display="block")}},Ft=()=>{for(const t in Ut)delete Ut[t];for(const t in Pt){Pt[t].removeSelf(),delete Pt[t]}},Nt=()=>{const t=document.querySelector("#dlHlsInfo");t&&"none"!==t.style.display&&(t.style.display="none");const e=document.querySelector("#recordInfo");e&&"none"!==e.style.display&&(e.style.display="none")},zt=(t,e,s)=>{const{cmd:r,params:i}=t;if(s||(s=()=>{}),"update_master"===r){(t=>{const e=t?.mId;e&&(Ut[e]=t)})(JSON.parse(i.master))}else if("update_video"===r){(t=>{Nt();const e=t?.vId;if(e){let s=Pt[e];s||(s=t.isLive?t.sourceType===b?new kt(t):new Dt(t):new xt(t),Pt[e]=s)}})(JSON.parse(i.video))}else if("video_progress"===r){const t=Pt[i.vId];t&&t.update_videoProgress(i)}else if("update_ui"===r){const{vId:t,action:e,message:s}=i,r=Pt[t];r&&(e===R?r.start():e===I?r.pause(s):e===C&&(r.removeSelf(),delete Pt[t]))}else if("flushed"===r){const{vId:t,url:e}=i,r=Pt[t];if(e)return fetch(e).then((t=>t.blob())).then((t=>{r&&(r.video.src=URL.createObjectURL(t),r.video.style.display="block"),s({result:!0})})).catch((t=>{s({result:!1})})),!0;r&&r.terminate()}else if("message"===r){const{vId:t,on:e,message:s}=i;if("title"===e)document.title=s;else if(t){const r=Pt[t];r&&r.setMessage(e,s)}}else if("subtitle_progress"===r){const{vId:t}=i,e=Pt[t];e&&e.update_subtitleProgress(i)}s({result:!0})};document.addEventListener("DOMContentLoaded",(async t=>{const e=document.getElementById("notInstallExt");e&&e.remove(),await(async()=>{const t=await Ot({cmd:"init",params:{counter:P.counter}});t&&(t.error||(Ct=new Tt(t),t.counter>P.counter&&(P.counter=t.counter,P.version=t.version,U(P))))})(),Ct&&((()=>{const t=document.getElementById("confirm-switch");t.addEventListener("click",(async()=>{if(t.checked){const e=document.getElementById("switchRecMode");document.getElementById("showSwitchRecModeDialog").click(),e.classList.add("active"),await new Promise(((t,s)=>{const r=e.querySelectorAll(".close-modal"),i=()=>{for(const t of r)t.removeEventListener("click",i);t(!1)};for(const t of r)t.addEventListener("click",i);const a=document.getElementById("confirmCaptureOKButton"),n=()=>{a.removeEventListener("click",n),t(!0)};a.addEventListener("click",n)}))?Ot({cmd:"intercept_request",params:{}})&&Bt(v):(t.checked=!1,document.querySelector("#switchRecMode .modal-title").innerHTML=p.getMessage("TswichtRecMode"),Ct.mode===v&&(Bt(y),Ot({cmd:"start_normal",params:{}}))),e.classList.remove("active")}else Bt(y),Ot({cmd:"start_normal",params:{}})})),document.querySelector("#switchRecMode .modal-title").innerHTML=p.getMessage("TswichtRecMode")})(),Ct.settings.mode===v?(Bt(v,!0),document.querySelector("#switchRecMode .modal-title").innerHTML=p.getMessage("TContinueRec"),document.getElementById("confirm-switch").click()):(Bt(y,!0),await Ot({cmd:"start_normal",params:{}}))),ht()}));